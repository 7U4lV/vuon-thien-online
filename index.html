<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meditation Room V4</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #1a1a2e;
        }

        .room-container {
            width: min(100vw, calc(100vh * 16/9));
            height: min(100vh, calc(100vw * 9/16));
            position: relative;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: cover;
            background-position: center;
            transition: background 0.5s ease;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .room-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1600 900"><defs><linearGradient id="skyGrad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:%23e8f4fd;stop-opacity:1" /><stop offset="70%" style="stop-color:%23b8e6b8;stop-opacity:1" /><stop offset="100%" style="stop-color:%2366bb6a;stop-opacity:1" /></linearGradient></defs><rect width="1600" height="900" fill="url(%23skyGrad)"/><circle cx="1400" cy="150" r="80" fill="%23ffeb3b" opacity="0.9"/><ellipse cx="200" cy="750" rx="150" ry="80" fill="%234caf50"/><ellipse cx="600" cy="780" rx="200" ry="100" fill="%234caf50"/><ellipse cx="1200" cy="730" rx="180" ry="90" fill="%234caf50"/><path d="M0,800 Q400,700 800,750 T1600,800 L1600,900 L0,900 Z" fill="%23388e3c"/><circle cx="300" cy="200" r="4" fill="%23fff" opacity="0.8"/><circle cx="800" cy="120" r="3" fill="%23fff" opacity="0.6"/><circle cx="1300" cy="250" r="5" fill="%23fff" opacity="0.7"/></svg>');
            background-size: cover;
            background-position: center;
            z-index: 1;
        }

        .character {
            position: absolute;
            width: 64px;
            height: 96px;
            cursor: pointer;
            transition: transform 0.3s ease;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }

        .character:hover {
            transform: scale(1.05);
        }

        .character.walking {
            animation: walk 0.6s infinite;
        }

        .character.sitting {
            cursor: default;
        }

        .character.meditating {
            animation: meditate 3s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.6));
        }

        @keyframes walk {
            0%, 100% { transform: translateY(0px) scaleX(1); }
            25% { transform: translateY(-2px) scaleX(0.98); }
            50% { transform: translateY(0px) scaleX(1); }
            75% { transform: translateY(-1px) scaleX(0.98); }
        }

        @keyframes meditate {
            0%, 100% { 
                filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.4));
                transform: scale(1);
            }
            50% { 
                filter: drop-shadow(0 0 25px rgba(255, 215, 0, 0.8));
                transform: scale(1.02);
            }
        }

        .character-body {
            width: 100%;
            height: 100%;
            position: relative;
            background: transparent;
        }

        .character.standing .character-body {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 96"><defs><radialGradient id="aura" cx="50%" cy="50%" r="60%"><stop offset="0%" style="stop-color:rgba(255,215,0,0);stop-opacity:0" /><stop offset="100%" style="stop-color:rgba(255,215,0,0);stop-opacity:0" /></radialGradient></defs><ellipse cx="32" cy="85" rx="15" ry="8" fill="rgba(0,0,0,0.2)"/><circle cx="32" cy="20" r="12" fill="%23fdbcb4" stroke="%23e8a48a" stroke-width="1"/><ellipse cx="29" cy="18" rx="1.5" ry="2" fill="%23333"/><ellipse cx="35" cy="18" rx="1.5" ry="2" fill="%23333"/><ellipse cx="32" cy="22" rx="2" ry="1" fill="%23d2a679"/><path d="M20 15 Q32 8 44 15 Q32 12 20 15" fill="%236b4423"/><rect x="26" y="32" width="12" height="20" rx="6" fill="%234a90e2"/><rect x="24" y="52" width="16" height="24" rx="8" fill="%232c3e50"/><circle cx="22" cy="38" r="3" fill="%23fdbcb4"/><circle cx="42" cy="38" r="3" fill="%23fdbcb4"/><ellipse cx="26" cy="80" rx="4" ry="8" fill="%23654321"/><ellipse cx="38" cy="80" rx="4" ry="8" fill="%23654321"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .character.sitting .character-body {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 96"><defs><radialGradient id="aura" cx="50%" cy="50%" r="80%"><stop offset="0%" style="stop-color:rgba(255,215,0,0.3);stop-opacity:0.6" /><stop offset="100%" style="stop-color:rgba(255,215,0,0);stop-opacity:0" /></radialGradient></defs><circle cx="32" cy="48" r="45" fill="url(%23aura)"/><ellipse cx="32" cy="85" rx="20" ry="10" fill="rgba(0,0,0,0.2)"/><circle cx="32" cy="25" r="12" fill="%23fdbcb4" stroke="%23e8a48a" stroke-width="1"/><ellipse cx="29" cy="23" rx="1" ry="1.5" fill="%23333"/><ellipse cx="35" cy="23" rx="1" ry="1.5" fill="%23333"/><path d="M28 26 Q32 28 36 26" stroke="%23333" stroke-width="1" fill="none"/><path d="M20 18 Q32 12 44 18 Q32 15 20 18" fill="%236b4423"/><rect x="26" y="37" width="12" height="18" rx="6" fill="%234a90e2"/><circle cx="32" cy="65" r="8" fill="%232c3e50"/><circle cx="20" cy="50" r="4" fill="%23fdbcb4"/><circle cx="44" cy="50" r="4" fill="%23fdbcb4"/><ellipse cx="24" cy="72" rx="6" ry="4" fill="%232c3e50"/><ellipse cx="40" cy="72" rx="6" ry="4" fill="%232c3e50"/><circle cx="28" cy="48" r="3" fill="%23fdbcb4"/><circle cx="36" cy="48" r="3" fill="%23fdbcb4"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .chat-bubble {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.95);
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 64px;
            width: auto;
            min-width: 40px;
            word-wrap: break-word;
            word-break: break-word;
            font-size: 10px;
            line-height: 1.2;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 15;
            animation: chatFadeInOut 5s ease-in-out;
            text-align: center;
            border: 2px solid rgba(255,255,255,0.8);
        }

        .chat-bubble::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid rgba(255,255,255,0.95);
        }

        @keyframes chatFadeInOut {
            0%, 100% { opacity: 0; transform: translateX(-50%) translateY(10px) scale(0.8); }
            10%, 90% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
        }

        .controls {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 18px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .btn:hover {
            background: rgba(255,255,255,1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn.active {
            background: #4caf50;
            color: white;
        }

        .btn.host-only {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            border: 2px solid gold;
        }

        .btn.host-only:hover {
            background: linear-gradient(135deg, #ff5252, #ffb74d);
            transform: translateY(-2px) scale(1.05);
        }

        .music-controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            max-width: 350px;
        }

        .music-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .music-item {
            padding: 8px;
            margin: 2px 0;
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .music-item:hover {
            background: rgba(255,255,255,1);
            transform: translateX(5px);
        }

        .music-item.playing {
            background: #4caf50;
            color: white;
        }

        .music-item.youtube {
            background: linear-gradient(135deg, #ff0000, #ff4444);
            color: white;
            border-left: 4px solid #cc0000;
        }

        .music-item.youtube:hover {
            background: linear-gradient(135deg, #cc0000, #ff0000);
        }

        .youtube-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .youtube-play-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.2s ease;
        }

        .youtube-play-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .youtube-embed {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none;
        }

        .youtube-embed iframe {
            border-radius: 10px;
        }

        .host-indicator {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
            border: 1px solid #ffc107;
            animation: hostGlow 2s ease-in-out infinite;
        }

        @keyframes hostGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); }
        }

        .chat-input {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            padding: 12px 18px;
            border: none;
            border-radius: 25px;
            width: 250px;
            background: rgba(255,255,255,0.9);
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .profile-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            max-height: 80vh;
            overflow-y: auto;
        }

        .profile-avatar {
            width: 80px;
            height: 120px;
            margin: 0 auto 20px;
            border: 3px solid #ddd;
            border-radius: 10px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .stars {
            color: #ffd700;
            font-size: 20px;
            margin: 10px 0;
        }

        .customization-panel {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .customization-section {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
        }

        .customization-section h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .option-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .option-item {
            width: 40px;
            height: 30px;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border 0.3s ease;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .option-item:hover, .option-item.selected {
            border-color: #4caf50;
            transform: scale(1.1);
        }

        .hidden {
            display: none !important;
        }

        .background-selector {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 15px;
            z-index: 150;
            display: none;
            backdrop-filter: blur(10px);
        }

        .bg-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 15px 0;
        }

        .bg-option {
            width: 80px;
            height: 60px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            background-size: cover;
            background-position: center;
        }

        .bg-option:hover, .bg-option.selected {
            border-color: #4caf50;
            transform: scale(1.05);
        }

        .achievement-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            margin: 3px;
        }

        .url-input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        #currentTrack {
            font-weight: bold;
            color: #4caf50;
            margin: 10px 0;
            font-size: 12px;
        }

        .volume-control {
            margin: 10px 0;
        }

        .volume-control input {
            width: 100%;
        }

        .character-status {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            white-space: nowrap;
            display: flex;
            align-items: center;
        }

        .move-indicator {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid #4caf50;
            border-radius: 50%;
            pointer-events: none;
            z-index: 5;
            animation: moveIndicator 1s ease-out;
        }

        @keyframes moveIndicator {
            0% { 
                transform: scale(0.5);
                opacity: 1;
                border-width: 4px;
            }
            100% { 
                transform: scale(1.5);
                opacity: 0;
                border-width: 1px;
            }
        }

        @keyframes fall {
            to {
                transform: translateY(calc(100vh + 50px)) rotate(360deg);
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                gap: 5px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 12px;
            }
            
            .music-controls {
                max-width: 280px;
                padding: 10px;
            }
            
            .chat-input input {
                width: 180px;
                padding: 10px 15px;
            }

            .youtube-embed {
                width: 90%;
                padding: 15px;
            }
        }

        .youtube-player-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 199;
            display: none;
        }
    </style>
</head>
<body>
    <div class="room-container" id="roomContainer">
        <div class="room-background"></div>
        
        <div class="controls">
            <button class="btn" id="standBtn" onclick="standUp()">🚶 ĐI</button>
            <button class="btn" id="sitBtn" onclick="sitDown()">🧘 NGỒI THIỀN</button>
            <button class="btn" onclick="showProfile()">👤 Profile</button>
            <button class="btn" onclick="showBackgroundSelector()">🎨 Đổi nền</button>
            <button class="btn host-only" id="hostBtn" onclick="toggleHost()">👑 HOST</button>
        </div>

        <div class="music-controls">
            <h4>🎵 Nhạc thiền</h4>
            <div id="currentTrack">Chưa phát nhạc</div>
            <div class="volume-control">
                <label>Âm lượng: </label>
                <input type="range" id="volumeSlider" min="0" max="100" value="50" onchange="setVolume(this.value)">
            </div>
            <div id="hostMusicControls" class="hidden">
                <input type="text" id="musicUrl" placeholder="Dán URL YouTube hoặc âm thanh trực tiếp" class="url-input">
                <button class="btn" onclick="addMusicFromUrl()">➕ Thêm nhạc</button>
                <input type="file" id="musicUpload" accept="audio/*" style="display:none" onchange="uploadMusic(event)">
                <button class="btn" onclick="document.getElementById('musicUpload').click()">📁 Upload nhạc</button>
            </div>
            <div class="music-list" id="musicList"></div>
        </div>

        <div class="chat-input">
            <input type="text" id="chatMessage" placeholder="Nhập tin nhắn..." maxlength="160" onkeypress="if(event.key==='Enter') sendMessage()">
            <button class="btn" onclick="sendMessage()">💬 Gửi</button>
        </div>
    </div>

    <!-- YouTube Player Overlay -->
    <div class="youtube-player-overlay" id="youtubeOverlay" onclick="closeYouTubePlayer()"></div>
    
    <!-- YouTube Embed -->
    <div class="youtube-embed" id="youtubeEmbed">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">🎵 YouTube Player</h3>
            <button class="btn" onclick="closeYouTubePlayer()" style="padding: 8px 12px;">❌ Đóng</button>
        </div>
        <iframe id="youtubeFrame" width="400" height="225" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
    </div>

    <!-- Profile Modal -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-content">
            <h3>Profile thiền sinh</h3>
            <div class="profile-avatar" id="profileAvatar"></div>
            <input type="text" id="userName" placeholder="Tên của bạn" style="width:100%; padding:10px; margin:10px 0; border:1px solid #ddd; border-radius:8px;">
            
            <div class="stars" id="achievementStars">⭐⭐⭐</div>
            <div id="achievementText">Thiền sinh tận tâm - 3 tuần kiên trì</div>
            
            <div class="achievement-badge">Người mới</div>
            <div class="achievement-badge">Kiên trì 1 tuần</div>
            <div class="achievement-badge">Thiền sư nhỏ</div>

            <div class="customization-panel">
                <div class="customization-section">
                    <h4>👕 Áo:</h4>
                    <div class="option-grid" id="shirtOptions"></div>
                </div>
                
                <div class="customization-section">
                    <h4>👖 Quần:</h4>
                    <div class="option-grid" id="pantsOptions"></div>
                </div>
                
                <div class="customization-section">
                    <h4>👟 Giày:</h4>
                    <div class="option-grid" id="shoesOptions"></div>
                </div>
                
                <div class="customization-section">
                    <h4>💇 Tóc:</h4>
                    <div class="option-grid" id="hairOptions"></div>
                </div>
                
                <div class="customization-section">
                    <h4>🎨 Màu da:</h4>
                    <div class="option-grid" id="skinOptions"></div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="btn" onclick="saveProfile()">💾 Lưu</button>
                <button class="btn" onclick="closeProfile()">❌ Đóng</button>
            </div>
        </div>
    </div>

    <!-- Character Profile Modal -->
    <div class="profile-modal" id="characterModal">
        <div class="profile-content">
            <div class="profile-avatar" id="characterAvatar"></div>
            <h3 id="characterName">Tên nhân vật</h3>
            <div class="stars" id="characterStars">⭐⭐</div>
            <p id="characterBio">Thiền sinh mới bắt đầu hành trình tìm hiểu bản thân.</p>
            <div style="margin-top: 20px;">
                <button class="btn">🤝 Kết bạn</button>
                <button class="btn">💬 Nhắn tin</button>
                <button class="btn" style="background:#f44336; color:white;">🚫 Block</button>
            </div>
            <button class="btn" onclick="closeCharacterModal()" style="margin-top:10px;">❌ Đóng</button>
        </div>
    </div>

    <!-- Background Selector -->
    <div class="background-selector" id="backgroundSelector">
        <h3>🌸 Chọn nền thiền</h3>
        <div class="bg-options">
            <div class="bg-option" data-bg="garden" style="background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
            <div class="bg-option" data-bg="forest" style="background-image: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);"></div>
            <div class="bg-option" data-bg="mountain" style="background-image: linear-gradient(135deg, #2196f3 0%, #21cbf3 100%);"></div>
            <div class="bg-option" data-bg="sunset" style="background-image: linear-gradient(135deg, #ff9800 0%, #f44336 100%);"></div>
            <div class="bg-option" data-bg="night" style="background-image: linear-gradient(135deg, #673ab7 0%, #3f51b5 100%);"></div>
            <div class="bg-option" data-bg="zen" style="background-image: linear-gradient(135deg, #795548 0%, #8d6e63 100%);"></div>
        </div>
        <input type="file" id="customBackground" accept="image/*" style="margin: 10px 0;">
        <div>
            <button class="btn" onclick="applyBackground()">✅ Áp dụng</button>
