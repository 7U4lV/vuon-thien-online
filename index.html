<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Meditation Room V2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        .room-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: cover;
            background-position: center;
            transition: background 0.5s ease;
        }

        .room-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><defs><linearGradient id="skyGrad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:%23e8f4fd;stop-opacity:1" /><stop offset="100%" style="stop-color:%23b8e6b8;stop-opacity:1" /></linearGradient></defs><rect width="1200" height="800" fill="url(%23skyGrad)"/><circle cx="200" cy="200" r="60" fill="%23ffeb3b" opacity="0.8"/><rect x="0" y="600" width="1200" height="200" fill="%2366bb6a"/><ellipse cx="300" cy="650" rx="80" ry="50" fill="%234caf50"/><ellipse cx="700" cy="680" rx="100" ry="60" fill="%234caf50"/><ellipse cx="1000" cy="630" rx="90" ry="45" fill="%234caf50"/><path d="M100,700 Q200,650 300,700 T500,700" stroke="%23388e3c" stroke-width="4" fill="none"/><circle cx="150" cy="150" r="3" fill="%23fff" opacity="0.7"/><circle cx="800" cy="100" r="2" fill="%23fff" opacity="0.6"/><circle cx="1000" cy="180" r="2.5" fill="%23fff" opacity="0.8"/></svg>');
            background-size: cover;
            background-position: center;
            z-index: 1;
        }

        .character {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .character:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .character.sitting {
            cursor: default;
            pointer-events: none;
        }

        .character img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .chat-bubble {
            position: absolute;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.95);
            padding: 8px 12px;
            border-radius: 20px;
            max-width: 160px;
            word-wrap: break-word;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 15;
            animation: fadeInOut 3s ease-in-out;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateX(-50%) translateY(10px); }
            10%, 90% { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .controls {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .btn:hover {
            background: rgba(255,255,255,1);
            transform: translateY(-2px);
        }

        .music-controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .music-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .music-item {
            padding: 8px;
            margin: 2px 0;
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .music-item:hover {
            background: rgba(255,255,255,1);
        }

        .music-item.playing {
            background: #4caf50;
            color: white;
        }

        .chat-input {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            padding: 10px 15px;
            border: none;
            border-radius: 25px;
            width: 200px;
            background: rgba(255,255,255,0.9);
            font-size: 14px;
        }

        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .profile-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 20px;
            border: 3px solid #ddd;
        }

        .stars {
            color: #ffd700;
            font-size: 20px;
            margin: 10px 0;
        }

        .avatar-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .avatar-option {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border 0.3s ease;
        }

        .avatar-option:hover, .avatar-option.selected {
            border-color: #4caf50;
        }

        .hidden {
            display: none !important;
        }

        .background-selector {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 15px;
            z-index: 150;
            display: none;
        }

        .bg-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 15px 0;
        }

        .bg-option {
            width: 80px;
            height: 60px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            background-size: cover;
            background-position: center;
        }

        .bg-option:hover, .bg-option.selected {
            border-color: #4caf50;
        }

        .achievement-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin: 2px;
        }

        .url-input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        #currentTrack {
            font-weight: bold;
            color: #4caf50;
            margin: 10px 0;
        }

        .volume-control {
            margin: 10px 0;
        }

        .volume-control input {
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="room-container">
        <div class="room-background"></div>
        
        <div class="controls">
            <button class="btn" onclick="sitDown()">Ng·ªìi thi·ªÅn</button>
            <button class="btn" onclick="standUp()">ƒê·ª©ng d·∫≠y</button>
            <button class="btn" onclick="showProfile()">Profile</button>
            <button class="btn" onclick="showBackgroundSelector()">ƒê·ªïi n·ªÅn</button>
        </div>

        <div class="music-controls">
            <h4>üéµ Nh·∫°c thi·ªÅn</h4>
            <div id="currentTrack">Ch∆∞a ph√°t nh·∫°c</div>
            <div class="volume-control">
                <label>√Çm l∆∞·ª£ng: </label>
                <input type="range" id="volumeSlider" min="0" max="100" value="50" onchange="setVolume(this.value)">
            </div>
            <input type="text" id="musicUrl" placeholder="D√°n URL YouTube/SoundCloud/Spotify" class="url-input">
            <button class="btn" onclick="addMusicFromUrl()">Th√™m nh·∫°c</button>
            <input type="file" id="musicUpload" accept="audio/*" style="display:none" onchange="uploadMusic(event)">
            <button class="btn" onclick="document.getElementById('musicUpload').click()">Upload nh·∫°c</button>
            <div class="music-list" id="musicList"></div>
        </div>

        <div class="chat-input">
            <input type="text" id="chatMessage" placeholder="Nh·∫≠p tin nh·∫Øn..." maxlength="160" onkeypress="if(event.key==='Enter') sendMessage()">
            <button class="btn" onclick="sendMessage()">G·ª≠i</button>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-content">
            <h3>Profile thi·ªÅn sinh</h3>
            <div class="profile-avatar">
                <img id="profileAvatar" src="" alt="Avatar">
            </div>
            <input type="text" id="userName" placeholder="T√™n c·ªßa b·∫°n" style="width:100%; padding:10px; margin:10px 0; border:1px solid #ddd; border-radius:5px;">
            
            <div class="stars" id="achievementStars">‚≠ê‚≠ê‚≠ê</div>
            <div id="achievementText">Thi·ªÅn sinh t·∫≠n t√¢m - 3 tu·∫ßn ki√™n tr√¨</div>
            
            <div class="achievement-badge">Ng∆∞·ªùi m·ªõi</div>
            <div class="achievement-badge">Ki√™n tr√¨ 1 tu·∫ßn</div>
            <div class="achievement-badge">Thi·ªÅn s∆∞ nh·ªè</div>

            <h4>Ch·ªçn avatar:</h4>
            <div class="avatar-selector" id="avatarSelector"></div>
            
            <div style="margin-top: 20px;">
                <button class="btn" onclick="saveProfile()">L∆∞u</button>
                <button class="btn" onclick="closeProfile()">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Character Profile Modal -->
    <div class="profile-modal" id="characterModal">
        <div class="profile-content">
            <div class="profile-avatar">
                <img id="characterAvatar" src="" alt="Avatar">
            </div>
            <h3 id="characterName">T√™n nh√¢n v·∫≠t</h3>
            <div class="stars" id="characterStars">‚≠ê‚≠ê</div>
            <p id="characterBio">Thi·ªÅn sinh m·ªõi b·∫Øt ƒë·∫ßu h√†nh tr√¨nh t√¨m hi·ªÉu b·∫£n th√¢n.</p>
            <div style="margin-top: 20px;">
                <button class="btn">K·∫øt b·∫°n</button>
                <button class="btn">Nh·∫Øn tin</button>
                <button class="btn" style="background:#f44336; color:white;">Block</button>
            </div>
            <button class="btn" onclick="closeCharacterModal()" style="margin-top:10px;">ƒê√≥ng</button>
        </div>
    </div>

    <!-- Background Selector -->
    <div class="background-selector" id="backgroundSelector">
        <h3>Ch·ªçn n·ªÅn thi·ªÅn</h3>
        <div class="bg-options">
            <div class="bg-option" data-bg="garden" style="background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
            <div class="bg-option" data-bg="forest" style="background-image: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);"></div>
            <div class="bg-option" data-bg="mountain" style="background-image: linear-gradient(135deg, #2196f3 0%, #21cbf3 100%);"></div>
            <div class="bg-option" data-bg="sunset" style="background-image: linear-gradient(135deg, #ff9800 0%, #f44336 100%);"></div>
            <div class="bg-option" data-bg="night" style="background-image: linear-gradient(135deg, #673ab7 0%, #3f51b5 100%);"></div>
            <div class="bg-option" data-bg="zen" style="background-image: linear-gradient(135deg, #795548 0%, #8d6e63 100%);"></div>
        </div>
        <input type="file" id="customBackground" accept="image/*" style="margin: 10px 0;">
        <div>
            <button class="btn" onclick="applyBackground()">√Åp d·ª•ng</button>
            <button class="btn" onclick="closeBackgroundSelector()">ƒê√≥ng</button>
        </div>
    </div>

    <audio id="meditationAudio" loop></audio>

    <script>
        // Avatar data
        const avatars = {
            male: [
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23fdbcb4"/><circle cx="50" cy="35" r="18" fill="%23fdbcb4"/><rect x="32" y="45" width="36" height="40" rx="18" fill="%234a90e2"/><circle cx="42" cy="30" r="2" fill="%23000"/><circle cx="58" cy="30" r="2" fill="%23000"/><path d="M45 38 Q50 42 55 38" stroke="%23000" stroke-width="2" fill="none"/></svg>',
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23d08b5b"/><circle cx="50" cy="35" r="18" fill="%23d08b5b"/><rect x="32" y="45" width="36" height="40" rx="18" fill="%23e74c3c"/><circle cx="42" cy="30" r="2" fill="%23000"/><circle cx="58" cy="30" r="2" fill="%23000"/><path d="M45 38 Q50 42 55 38" stroke="%23000" stroke-width="2" fill="none"/></svg>',
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23f1c27d"/><circle cx="50" cy="35" r="18" fill="%23f1c27d"/><rect x="32" y="45" width="36" height="40" rx="18" fill="%2327ae60"/><circle cx="42" cy="30" r="2" fill="%23000"/><circle cx="58" cy="30" r="2" fill="%23000"/><path d="M45 38 Q50 42 55 38" stroke="%23000" stroke-width="2" fill="none"/></svg>',
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23ffdbac"/><circle cx="50" cy="35" r="18" fill="%23ffdbac"/><rect x="32" y="45" width="36" height="40" rx="18" fill="%23f39c12"/><circle cx="42" cy="30" r="2" fill="%23000"/><circle cx="58" cy="30" r="2" fill="%23000"/><path d="M45 38 Q50 42 55 38" stroke="%23000" stroke-width="2" fill="none"/></svg>',
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%238d5524"/><circle cx="50" cy="35" r="18" fill="%238d5524"/><rect x="32" y="45" width="36" height="40" rx="18" fill="%239b59b6"/><circle cx="42" cy="30" r="2" fill="%23000"/><circle cx="58" cy="30" r="2" fill="%23000"/><path d="M45 38 Q50 42 55 38" stroke="%23000" stroke-width="2" fill="none"/></svg>',
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23c0392b"/><circle cx="50" cy="35" r="18" fill="%23c0392b"/><rect x="32" y="45" width="36" height="40" rx="18" fill="%2334495e"/><circle cx="42" cy="30" r="2" fill="%23000"/><circle cx="58" cy="30" r="2" fill="%23000"/><path d="M45 38 Q50 42 55 38" stroke="%23000" stroke-width="2" fill="none"/></svg>',
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23f7dc6f"/><circle cx="50" cy="35" r="18" fill="%23f7dc6f"/><rect x="32" y="45" width="36" height="40" rx="18" fill="%231abc9c"/><circle cx="42" cy="30" r="2" fill="%23000"/><circle cx="58" cy="30" r="2" fill="%23000"/><path d="M45 38 Q50 42 55 38" stroke="%23000" stroke-width="2" fill="none"/></svg>',
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23fadbd8"/><circle cx="50" cy="35" r="18" fill="%23fadbd8"/><rect x="32" y="45" width="36" height="40" rx="18" fill="%232980b9"/><circle cx="42" cy="30" r="2" fill="%23000"/><circle cx="58" cy="30" r="2" fill="%23000"/><path d="M45 38 Q50 42 55 38" stroke="%23000" stroke-width="2" fill="none"/></svg>',
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23e8daef"/><circle cx="50" cy="35" r="18" fill="%23e8daef"/><rect x="32" y="45" width="36" height="40" rx="18" fill="%23e67e22"/><circle cx="42" cy="30" r="2" fill="%23000"/><circle cx="58" cy="30" r="2" fill="%23000"/><path d="M45 38 Q50 42 55 38" stroke="%23000" stroke-width="2" fill="none"/></svg>',
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23a9dfbf"/><circle cx="50" cy="35" r="18" fill="%23a9dfbf"/><rect x="32" y="45" width="36" height="40" rx="18" fill="%2316a085"/><circle cx="42" cy="30" r="2" fill="%23000"/><circle cx="58" cy="30" r="2" fill="%23000"/><path d="M45 38 Q50 42 55 38" stroke="%23000" stroke-width="2" fill="none"/></svg>'
            ],
            female: [
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23fdbcb4"/><circle cx="50" cy="35" r="18" fill="%23fdbcb4"/><rect x="32" y="45" width="36" height="40" rx="18" fill="%23e91e63"/><circle cx="42" cy="30" r="2" fill="%23000"/><circle cx="58" cy="30" r="2" fill="%23000"/><path d="M45 38 Q50 42 55 38" stroke="%23000" stroke-width="2" fill="none"/><path d="M35 25 Q50 20 65 25" stroke="%23d2691e" stroke-width="3" fill="none"/></svg>',
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23d08b5b"/><circle cx="50" cy="35" r="18" fill="%23d08b5b"/><rect x="32" y="45" width="36" height="40" rx="18" fill="%239c27b0"/><circle cx="42" cy="30" r="2" fill="%23000"/><circle cx="58" cy="30" r="2" fill="%23000"/><path d="M45 38 Q50 42 55 38" stroke="%23000" stroke-width="2" fill="none"/><path d="M35 25 Q50 20 65 25" stroke="%23000" stroke-width="3" fill="none"/></svg>',
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23f1c27d"/><circle cx="50" cy="35" r="18" fill="%23f1c27d"/><rect x="32" y="45" width="36" height="40" rx="18" fill="%23ff5722"/><circle cx="42" cy="30" r="2" fill="%23000"/><circle cx="58" cy="30" r="2" fill="%23000"/><path d="M45 38 Q50 42 55 38" stroke="%23000" stroke-width="2" fill="none"/><path d="M35 25 Q50 20 65 25" stroke="%23ffd54f" stroke-width="3" fill="none"/></svg>',
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23ffdbac"/><circle cx="50" cy="35" r="18" fill="%23ffdbac"/><rect x="32" y="45" width="36" height="40" rx="18" fill="%23673ab7"/><circle cx="42" cy="30" r="2" fill="%23000"/><circle cx="58" cy="30" r="2" fill="%23000"/><path d="M45 38 Q50 42 55 38" stroke="%23000" stroke-width="2" fill="none"/><path d="M35 25 Q50 20 65 25" stroke="%23ff6f00" stroke-width="3" fill="none"/></svg>',
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%238d5524"/><circle cx="50" cy="35" r="18" fill="%238d5524"/><rect x="32" y="45" width="36" height="40" rx="18" fill="%23795548"/><circle cx="42" cy="30" r="2" fill="%23000"/><circle cx="58" cy="30" r="2" fill="%23000"/><path d="M45 38 Q50 42 55 38" stroke="%23000" stroke-width="2" fill="none"/><path d="M35 25 Q50 20 65 25" stroke="%236d4c41" stroke-width="3" fill="none"/></svg>',
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23c0392b"/><circle cx="50" cy="35" r="18" fill="%23c0392b"/><rect x="32" y="45" width="36" height="40" rx="18" fill="%23607d8b"/><circle cx="42" cy="30" r="2" fill="%23000"/><circle cx="58" cy="30" r="2" fill="%23000"/><path d="M45 38 Q50 42 55 38" stroke="%23000" stroke-width="2" fill="none"/><path d="M35 25 Q50 20 65 25" stroke="%23000" stroke-width="3" fill="none"/></svg>',
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23f7dc6f"/><circle cx="50" cy="35" r="18" fill="%23f7dc6f"/><rect x="32" y="45" width="36" height="40" rx="18" fill="%23388e3c"/><circle cx="42" cy="30" r="2" fill="%23000"/><circle cx="58" cy="30" r="2" fill="%23000"/><path d="M45 38 Q50 42 55 38" stroke="%23000" stroke-width="2" fill="none"/><path d="M35 25 Q50 20 65 25" stroke="%23ffb300" stroke-width="3" fill="none"/></svg>',
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23fadbd8"/><circle cx="50" cy="35" r="18" fill="%23fadbd8"/><rect x="32" y="45" width="36" height="40" rx="18" fill="%23d32f2f"/><circle cx="42" cy="30" r="2" fill="%23000"/><circle cx="58" cy="30" r="2" fill="%23000"/><path d="M45 38 Q50 42 55 38" stroke="%23000" stroke-width="2" fill="none"/><path d="M35 25 Q50 20 65 25" stroke="%23ff8a65" stroke-width="3" fill="none"/></svg>',
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23e8daef"/><circle cx="50" cy="35" r="18" fill="%23e8daef"/><rect x="32" y="45" width="36" height="40" rx="18" fill="%238e44ad"/><circle cx="42" cy="30" r="2" fill="%23000"/><circle cx="58" cy="30" r="2" fill="%23000"/><path d="M45 38 Q50 42 55 38" stroke="%23000" stroke-width="2" fill="none"/><path d="M35 25 Q50 20 65 25" stroke="%23d63031" stroke-width="3" fill="none"/></svg>',
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23a9dfbf"/><circle cx="50" cy="35" r="18" fill="%23a9dfbf"/><rect x="32" y="45" width="36" height="40" rx="18" fill="%232c3e50"/><circle cx="42" cy="30" r="2" fill="%23000"/><circle cx="58" cy="30" r="2" fill="%23000"/><path d="M45 38 Q50 42 55 38" stroke="%23000" stroke-width="2" fill="none"/><path d="M35 25 Q50 20 65 25" stroke="%2327ae60" stroke-width="3" fill="none"/></svg>'
            ]
        };

        // Game state
        let gameState = {
            characters: new Map(),
            myCharacter: null,
            isSitting: false,
            currentMusic: null,
            musicList: [],
            selectedAvatar: 0,
            userName: '',
            meditationDays: 0,
            joinDate: new Date(),
            currentBackground: 'garden'
        };

        // Default meditation tracks
        const defaultTracks = [
            { name: 'üåä S√≥ng bi·ªÉn nh·∫π nh√†ng', url: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmI3CjSW2e/Hci...' },
            { name: 'üéã Ti·∫øng chim r·ª´ng', url: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmI3CjSW2e/Hci...' },
            { name: '‚òØ Chu√¥ng T√¢y T·∫°ng', url: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmI3CjSW2e/Hci...' },
            { name: 'üßò √Çm Om thi·ªÅn ƒë·ªãnh', url: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmI3CjSW2e/Hci...' }
        ];

        // Initialize
        function init() {
            loadUserData();
            setupAvatarSelector();
            setupMusicList();
            setupBackgroundOptions();
            createMyCharacter();
            addOtherCharacters();
            
            // Auto-save every 30 seconds
            setInterval(saveUserData, 30000);
        }

        function loadUserData() {
            const saved = localStorage.getItem('meditationRoom') || '{}';
            const data = JSON.parse(saved);
            
            gameState.userName = data.userName || 'Thi·ªÅn sinh m·ªõi';
            gameState.selectedAvatar = data.selectedAvatar || 0;
            gameState.joinDate = new Date(data.joinDate || Date.now());
            gameState.meditationDays = data.meditationDays || 0;
            gameState.currentBackground = data.currentBackground || 'garden';
            
            // Calculate achievement days
            const daysDiff = Math.floor((Date.now() - gameState.joinDate.getTime()) / (1000 * 60 * 60 * 24));
            gameState.meditationDays = Math.max(daysDiff, gameState.meditationDays);
            
            applyBackground();
        }

        function saveUserData() {
            const data = {
                userName: gameState.userName,
                selectedAvatar: gameState.selectedAvatar,
                joinDate: gameState.joinDate.toISOString(),
                meditationDays: gameState.meditationDays,
                currentBackground: gameState.currentBackground
            };
            localStorage.setItem('meditationRoom', JSON.stringify(data));
        }

        function setupAvatarSelector() {
            const selector = document.getElementById('avatarSelector');
            const allAvatars = [...avatars.male, ...avatars.female];
            
            allAvatars.forEach((avatar, index) => {
                const img = document.createElement('img');
                img.src = avatar;
                img.className = 'avatar-option';
                if (index === gameState.selectedAvatar) {
                    img.classList.add('selected');
                }
                img.onclick = () => selectAvatar(index);
                selector.appendChild(img);
            });
        }

        function selectAvatar(index) {
            gameState.selectedAvatar = index;
            document.querySelectorAll('.avatar-option').forEach((el, i) => {
                el.classList.toggle('selected', i === index);
            });
            
            if (gameState.myCharacter) {
                const allAvatars = [...avatars.male, ...avatars.female];
                gameState.myCharacter.querySelector('img').src = allAvatars[index];
                document.getElementById('profileAvatar').src = allAvatars[index];
            }
        }

        function setupMusicList() {
            gameState.musicList = [...defaultTracks];
            updateMusicList();
        }

        function updateMusicList() {
            const list = document.getElementById('musicList');
            list.innerHTML = '';
            
            gameState.musicList.forEach((track, index) => {
                const item = document.createElement('div');
                item.className = 'music-item';
                item.textContent = track.name;
                item.onclick = () => playMusic(index);
                if (gameState.currentMusic === index) {
                    item.classList.add('playing');
                }
                list.appendChild(item);
            });
        }

        function playMusic(index) {
            const audio = document.getElementById('meditationAudio');
            const track = gameState.musicList[index];
            
            if (gameState.currentMusic === index && !audio.paused) {
                audio.pause();
                gameState.currentMusic = null;
                document.getElementById('currentTrack').textContent = 'ƒê√£ d·ª´ng';
            } else {
                audio.src = track.url;
                audio.play().catch(e => {
                    console.log('Cannot play audio:', e);
                });
                gameState.currentMusic = index;
                document.getElementById('currentTrack').textContent = `ƒêang ph√°t: ${track.name}`;
            }
            updateMusicList();
        }

        function addMusicFromUrl() {
            const urlInput = document.getElementById('musicUrl');
            const url = urlInput.value.trim();
            
            if (!url) return;
            
            // Extract video ID from YouTube URL
            let audioUrl = url;
            let trackName = 'Nh·∫°c t√πy ch·ªânh';
            
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                trackName = 'üéµ YouTube Track';
                // Note: In a real app, you'd need a service to convert YouTube to audio
                alert('T√≠nh nƒÉng YouTube ƒëang ph√°t tri·ªÉn. Vui l√≤ng s·ª≠ d·ª•ng file audio tr·ª±c ti·∫øp.');
                return;
            } else if (url.includes('soundcloud.com')) {
                trackName = 'üéß SoundCloud Track';
                alert('T√≠nh nƒÉng SoundCloud ƒëang ph√°t tri·ªÉn. Vui l√≤ng s·ª≠ d·ª•ng file audio tr·ª±c ti·∫øp.');
                return;
            } else if (url.includes('spotify.com')) {
                trackName = 'üé∂ Spotify Track';
                alert('T√≠nh nƒÉng Spotify ƒëang ph√°t tri·ªÉn. Vui l√≤ng s·ª≠ d·ª•ng file audio tr·ª±c ti·∫øp.');
                return;
            }
            
            gameState.musicList.push({ name: trackName, url: audioUrl });
            updateMusicList();
            urlInput.value = '';
        }

        function uploadMusic(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const audioUrl = e.target.result;
                const trackName = `üéµ ${file.name}`;
                gameState.musicList.push({ name: trackName, url: audioUrl });
                updateMusicList();
            };
            reader.readAsDataURL(file);
        }

        function setVolume(value) {
            const audio = document.getElementById('meditationAudio');
            audio.volume = value / 100;
        }

        function createMyCharacter() {
            const character = document.createElement('div');
            character.className = 'character';
            character.style.left = '50%';
            character.style.top = '50%';
            character.style.transform = 'translate(-50%, -50%)';
            
            const img = document.createElement('img');
            const allAvatars = [...avatars.male, ...avatars.female];
            img.src = allAvatars[gameState.selectedAvatar];
            character.appendChild(img);
            
            character.onclick = () => showProfile();
            
            document.querySelector('.room-container').appendChild(character);
            gameState.myCharacter = character;
        }

        function addOtherCharacters() {
            // Add some demo characters
            const demoCharacters = [
                { x: 30, y: 30, avatar: 5, name: 'Minh An', stars: 2 },
                { x: 70, y: 40, avatar: 12, name: 'Thu H√†', stars: 4 },
                { x: 20, y: 70, avatar: 8, name: 'ƒê·ª©c Anh', stars: 1 },
                { x: 80, y: 75, avatar: 15, name: 'Linh Chi', stars: 3 }
            ];
            
            const allAvatars = [...avatars.male, ...avatars.female];
            
            demoCharacters.forEach((demo, index) => {
                const character = document.createElement('div');
                character.className = 'character';
                character.style.left = demo.x + '%';
                character.style.top = demo.y + '%';
                
                const img = document.createElement('img');
                img.src = allAvatars[demo.avatar];
                character.appendChild(img);
                
                character.onclick = () => showCharacterProfile(demo);
                
                document.querySelector('.room-container').appendChild(character);
                gameState.characters.set(index, { element: character, data: demo });
            });
        }

        function sitDown() {
            if (!gameState.isSitting) {
                gameState.isSitting = true;
                gameState.myCharacter.classList.add('sitting');
                gameState.myCharacter.style.pointerEvents = 'none';
                
                // Disable movement
                gameState.myCharacter.onmousedown = null;
                gameState.myCharacter.ontouchstart = null;
            }
        }

        function standUp() {
            if (gameState.isSitting) {
                gameState.isSitting = false;
                gameState.myCharacter.classList.remove('sitting');
                gameState.myCharacter.style.pointerEvents = 'auto';
                
                // Enable movement
                setupMovement();
            }
        }

        function setupMovement() {
            let isDragging = false;
            let startX, startY, initialX, initialY;
            
            gameState.myCharacter.onmousedown = startDrag;
            gameState.myCharacter.ontouchstart = startDrag;
            
            function startDrag(e) {
                if (gameState.isSitting) return;
                
                isDragging = true;
                const event = e.type === 'touchstart' ? e.touches[0] : e;
                startX = event.clientX;
                startY = event.clientY;
                
                const rect = gameState.myCharacter.getBoundingClientRect();
                initialX = rect.left + rect.width / 2;
                initialY = rect.top + rect.height / 2;
                
                document.onmousemove = drag;
                document.ontouchmove = drag;
                document.onmouseup = stopDrag;
                document.ontouchend = stopDrag;
                
                e.preventDefault();
            }
            
            function drag(e) {
                if (!isDragging || gameState.isSitting) return;
                
                const event = e.type === 'touchmove' ? e.touches[0] : e;
                const deltaX = event.clientX - startX;
                const deltaY = event.clientY - startY;
                
                const newX = ((initialX + deltaX) / window.innerWidth) * 100;
                const newY = ((initialY + deltaY) / window.innerHeight) * 100;
                
                // Keep character within bounds
                const boundedX = Math.max(5, Math.min(95, newX));
                const boundedY = Math.max(5, Math.min(95, newY));
                
                gameState.myCharacter.style.left = boundedX + '%';
                gameState.myCharacter.style.top = boundedY + '%';
                gameState.myCharacter.style.transform = 'translate(-50%, -50%)';
                
                e.preventDefault();
            }
            
            function stopDrag() {
                isDragging = false;
                document.onmousemove = null;
                document.ontouchmove = null;
                document.onmouseup = null;
                document.ontouchend = null;
            }
        }

        function sendMessage() {
            const input = document.getElementById('chatMessage');
            const message = input.value.trim();
            
            if (message && message.length <= 160) {
                showChatBubble(gameState.myCharacter, message);
                input.value = '';
            }
        }

        function showChatBubble(character, message) {
            // Remove existing bubble
            const existingBubble = character.querySelector('.chat-bubble');
            if (existingBubble) {
                existingBubble.remove();
            }
            
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble';
            bubble.textContent = message;
            character.appendChild(bubble);
            
            setTimeout(() => {
                if (bubble.parentNode) {
                    bubble.remove();
                }
            }, 3000);
        }

        function showProfile() {
            const modal = document.getElementById('profileModal');
            const allAvatars = [...avatars.male, ...avatars.female];
            
            document.getElementById('profileAvatar').src = allAvatars[gameState.selectedAvatar];
            document.getElementById('userName').value = gameState.userName;
            
            // Update achievements
            const weeks = Math.floor(gameState.meditationDays / 7);
            const stars = Math.min(weeks, 10);
            document.getElementById('achievementStars').textContent = '‚≠ê'.repeat(stars) || 'üå±';
            
            let achievementText = 'Thi·ªÅn sinh m·ªõi b·∫Øt ƒë·∫ßu';
            if (weeks >= 1) achievementText = 'Ki√™n tr√¨ 1 tu·∫ßn';
            if (weeks >= 2) achievementText = 'Thi·ªÅn sinh t·∫≠n t√¢m';
            if (weeks >= 4) achievementText = 'Thi·ªÅn s∆∞ nh·ªè';
            if (weeks >= 8) achievementText = 'B·∫≠c th·∫ßy thi·ªÅn ƒë·ªãnh';
            if (weeks >= 16) achievementText = 'Enlightened Master';
            
            document.getElementById('achievementText').textContent = achievementText;
            
            modal.style.display = 'flex';
        }

        function closeProfile() {
            document.getElementById('profileModal').style.display = 'none';
        }

        function saveProfile() {
            gameState.userName = document.getElementById('userName').value || 'Thi·ªÅn sinh m·ªõi';
            saveUserData();
            closeProfile();
        }

        function showCharacterProfile(characterData) {
            const modal = document.getElementById('characterModal');
            const allAvatars = [...avatars.male, ...avatars.female];
            
            document.getElementById('characterAvatar').src = allAvatars[characterData.avatar];
            document.getElementById('characterName').textContent = characterData.name;
            document.getElementById('characterStars').textContent = '‚≠ê'.repeat(characterData.stars);
            
            const bios = [
                'Thi·ªÅn sinh m·ªõi b·∫Øt ƒë·∫ßu h√†nh tr√¨nh t√¨m hi·ªÉu b·∫£n th√¢n.',
                'Ng∆∞·ªùi y√™u thi√™n nhi√™n v√† t√¨m ki·∫øm s·ª± b√¨nh an n·ªôi t√¢m.',
                'Thi·ªÅn s∆∞ tr·∫ª v·ªõi ni·ªÅm ƒëam m√™ chia s·∫ª tr√≠ tu·ªá.',
                'B·∫≠c th·∫ßy thi·ªÅn ƒë·ªãnh v·ªõi nhi·ªÅu nƒÉm kinh nghi·ªám.'
            ];
            
            document.getElementById('characterBio').textContent = bios[Math.min(characterData.stars - 1, 3)];
            modal.style.display = 'flex';
        }

        function closeCharacterModal() {
            document.getElementById('characterModal').style.display = 'none';
        }

        function setupBackgroundOptions() {
            const backgrounds = {
                garden: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                forest: 'linear-gradient(135deg, #4caf50 0%, #8bc34a 100%)',
                mountain: 'linear-gradient(135deg, #2196f3 0%, #21cbf3 100%)',
                sunset: 'linear-gradient(135deg, #ff9800 0%, #f44336 100%)',
                night: 'linear-gradient(135deg, #673ab7 0%, #3f51b5 100%)',
                zen: 'linear-gradient(135deg, #795548 0%, #8d6e63 100%)'
            };
            
            const options = document.querySelectorAll('.bg-option');
            options.forEach(option => {
                const bg = option.dataset.bg;
                option.style.backgroundImage = backgrounds[bg];
                option.onclick = () => {
                    options.forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    gameState.currentBackground = bg;
                };
            });
            
            // Custom background upload
            document.getElementById('customBackground').onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        gameState.currentBackground = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };
        }

        function showBackgroundSelector() {
            document.getElementById('backgroundSelector').style.display = 'block';
        }

        function closeBackgroundSelector() {
            document.getElementById('backgroundSelector').style.display = 'none';
        }

        function applyBackground() {
            const container = document.querySelector('.room-background');
            
            if (gameState.currentBackground.startsWith('data:')) {
                // Custom uploaded image
                container.style.backgroundImage = `url('${gameState.currentBackground}')`;
            } else {
                // Predefined backgrounds
                const backgrounds = {
                    garden: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    forest: 'linear-gradient(135deg, #4caf50 0%, #8bc34a 100%)',
                    mountain: 'linear-gradient(135deg, #2196f3 0%, #21cbf3 100%)',
                    sunset: 'linear-gradient(135deg, #ff9800 0%, #f44336 100%)',
                    night: 'linear-gradient(135deg, #673ab7 0%, #3f51b5 100%)',
                    zen: 'linear-gradient(135deg, #795548 0%, #8d6e63 100%)'
                };
                container.style.backgroundImage = backgrounds[gameState.currentBackground];
            }
            
            saveUserData();
            closeBackgroundSelector();
        }

        // Initialize on load
        window.onload = init;
        
        // Handle resize
        window.onresize = function() {
            // Room automatically adjusts to viewport size via CSS
        };
    </script>
</body>
</html>
