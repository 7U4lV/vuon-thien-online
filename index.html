<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MGO Meditation Room V3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #1a1a2e;
        }

        .room-container {
            width: min(100vw, calc(100vh * 9/16));
            height: min(100vh, calc(100vw * 16/9));
            position: relative;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: cover;
            background-position: center;
            transition: background 0.5s ease;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .room-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 1600"><defs><linearGradient id="skyGrad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:%23e8f4fd;stop-opacity:1" /><stop offset="70%" style="stop-color:%23b8e6b8;stop-opacity:1" /><stop offset="100%" style="stop-color:%2366bb6a;stop-opacity:1" /></linearGradient></defs><rect width="900" height="1600" fill="url(%23skyGrad)"/><circle cx="1400" cy="150" r="80" fill="%23ffeb3b" opacity="0.9"/><ellipse cx="200" cy="750" rx="150" ry="80" fill="%234caf50"/><ellipse cx="600" cy="780" rx="200" ry="100" fill="%234caf50"/><ellipse cx="1200" cy="730" rx="180" ry="90" fill="%234caf50"/><path d="M0,800 Q400,700 800,750 T1600,800 L1600,900 L0,900 Z" fill="%23388e3c"/><circle cx="300" cy="200" r="4" fill="%23fff" opacity="0.8"/><circle cx="800" cy="120" r="3" fill="%23fff" opacity="0.6"/><circle cx="1300" cy="250" r="5" fill="%23fff" opacity="0.7"/></svg>');
            background-size: cover;
            background-position: center;
            z-index: 1;
        }

        .character {
            position: absolute;
            width: 64px;
            height: 96px;
            cursor: pointer;
            transition: transform 0.3s ease;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }

        .character:hover {
            transform: scale(1.05);
        }

        .character.walking {
            animation: walk 0.6s infinite;
        }

        .character.sitting {
            cursor: default;
        }

        .character.meditating {
            animation: meditate 3s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.6));
        }

        @keyframes walk {
            0%, 100% { transform: translateY(0px) scaleX(1); }
            25% { transform: translateY(-2px) scaleX(0.98); }
            50% { transform: translateY(0px) scaleX(1); }
            75% { transform: translateY(-1px) scaleX(0.98); }
        }

        @keyframes meditate {
            0%, 100% { 
                filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.4));
                transform: scale(1);
            }
            50% { 
                filter: drop-shadow(0 0 25px rgba(255, 215, 0, 0.8));
                transform: scale(1.02);
            }
        }

        .character-body {
            width: 100%;
            height: 100%;
            position: relative;
            background: transparent;
        }

        .character.standing .character-body {
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .character.sitting .character-body {
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .chat-bubble {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.95);
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 64px;
            width: auto;
            min-width: 40px;
            word-wrap: break-word;
            word-break: break-word;
            font-size: 10px;
            line-height: 1.2;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 15;
            animation: chatFadeInOut 5s ease-in-out;
            text-align: center;
            border: 2px solid rgba(255,255,255,0.8);
        }

        .chat-bubble::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid rgba(255,255,255,0.95);
        }

        @keyframes chatFadeInOut {
            0%, 100% { opacity: 0; transform: translateX(-50%) translateY(10px) scale(0.8); }
            10%, 90% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
        }

        .controls {
            position: absolute;
            top: 5%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            gap: 5px;
            justify-content: center;
            width: 90%;
            max-width: 400px;
        }

        .btn {
            padding: 6px 9px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 6.5px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn:hover {
            background: rgba(255,255,255,1);
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }

        .btn.active {
            background: #4caf50;
            color: white;
        }

        .music-toggle {
            position: absolute;
            bottom: 5%;
            left: 5%;
            z-index: 101;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .music-toggle:hover {
            background: rgba(255,255,255,1);
            transform: scale(1.1);
        }

        .music-controls {
            position: absolute;
            bottom: 5%;
            left: 5%;
            z-index: 100;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            max-width: 300px;
            display: none;
            transition: all 0.3s ease;
        }

        .embed-input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 12px;
        }

        .chat-input {
            position: absolute;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            gap: 10px;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            width: 90%;
            max-width: 400px;
        }

        .chat-input input {
            flex: 1;
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.9);
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        .chat-input button {
            padding: 8px 15px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .chat-input button:hover {
            background: rgba(255,255,255,1);
            transform: scale(1.05);
        }

        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .profile-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            max-height: 80vh;
            overflow-y: auto;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            border: 3px solid #ddd;
            border-radius: 50%;
            font-size: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .profile-avatar:hover {
            transform: scale(1.1);
        }

        .emoji-selector {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 10px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .emoji-option {
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            transition: all 0.3s ease;
            text-align: center;
        }

        .emoji-option:hover {
            background: #ddd;
            transform: scale(1.2);
        }

        .emoji-option.selected {
            background: #4caf50;
            transform: scale(1.1);
        }

        .stars {
            color: #ffd700;
            font-size: 20px;
            margin: 10px 0;
        }

        .background-selector {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 15px;
            z-index: 150;
            display: none;
            backdrop-filter: blur(10px);
        }

        .bg-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 15px 0;
        }

        .bg-option {
            width: 80px;
            height: 60px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            background-size: cover;
            background-position: center;
        }

        .bg-option:hover, .bg-option.selected {
            border-color: #4caf50;
            transform: scale(1.05);
        }

        .achievement-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            margin: 3px;
        }

        .character-status {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            white-space: nowrap;
        }

        .move-indicator {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid #4caf50;
            border-radius: 50%;
            pointer-events: none;
            z-index: 5;
            animation: moveIndicator 1s ease-out;
        }

        @keyframes moveIndicator {
            0% { 
                transform: scale(0.5);
                opacity: 1;
                border-width: 4px;
            }
            100% { 
                transform: scale(1.5);
                opacity: 0;
                border-width: 1px;
            }
        }

        @keyframes fall {
            to {
                transform: translateY(calc(100vh + 50px)) rotate(360deg);
                opacity: 0;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .btn {
                font-size: 5px;
                padding: 4px 6px;
            }
            
            .music-toggle {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
            
            .music-controls {
                max-width: 250px;
                padding: 10px;
            }
            
            .chat-input input {
                font-size: 11px;
            }
            
            .chat-input button {
                font-size: 10px;
                padding: 6px 12px;
            }
        }

        @media (orientation: portrait) {
            .btn {
                font-size: 4.5px;
                padding: 3px 5px;
            }
            
            .controls {
                gap: 3px;
            }
        }

        /* YouTube embed hidden */
        #ytplayer {
            position: absolute;
            top: -9999px;
            left: -9999px;
        }
    </style>
</head>
<body>
    <div class="room-container" id="roomContainer">
        <div class="room-background"></div>
        
        <div class="controls">
            <button class="btn" id="standBtn" onclick="standUp()">🚶 ĐI</button>
            <button class="btn" id="sitBtn" onclick="sitDown()">🧘 NGỒI THIỀN</button>
            <button class="btn" onclick="showProfile()">👤 PROFILE</button>
            <button class="btn" onclick="showBackgroundSelector()">🎨 ĐỔI NỀN</button>
        </div>

        <button class="music-toggle" onclick="toggleMusicPanel()">♪</button>
        
        <div class="music-controls">
            <h4>🎵 Nhạc thiền YouTube</h4>
            <input type="text" id="youtubeUrl" placeholder="Dán URL YouTube video" class="embed-input">
            <button class="btn" onclick="updateYouTubeEmbed()" style="width: 100%; margin: 10px 0;">Cập nhật nhạc</button>
        </div>

        <div class="chat-input">
            <input type="text" id="chatMessage" placeholder="Nhập tin nhắn..." maxlength="160" onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()">💬</button>
        </div>
    </div>

    <!-- Hidden YouTube Player -->
    <iframe id="ytplayer" type="text/html" width="1" height="1"
        src="https://www.youtube.com/embed/M7lc1UVf-VE?autoplay=1&controls=0&loop=1&playlist=M7lc1UVf-VE"
        frameborder="0" allow="autoplay" allowfullscreen>
    </iframe>

    <!-- Profile Modal -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-content">
            <h3>Profile thiền sinh</h3>
            <div class="profile-avatar" id="profileAvatar" onclick="showEmojiSelector()">🧘</div>
            <div class="emoji-selector hidden" id="emojiSelector"></div>
            <input type="text" id="userName" placeholder="Tên của bạn" style="width:100%; padding:10px; margin:10px 0; border:1px solid #ddd; border-radius:8px;">
            
            <div class="stars" id="achievementStars">⭐⭐⭐</div>
            <div id="achievementText">Thiền sinh tận tâm - 3 tuần kiên trì</div>
            
            <div class="achievement-badge">Người mới</div>
            <div class="achievement-badge">Kiên trì 1 tuần</div>
            <div class="achievement-badge">Thiền sư nhỏ</div>
            
            <div style="margin-top: 20px;">
                <button class="btn" onclick="saveProfile()">💾 Lưu</button>
                <button class="btn" onclick="closeProfile()">❌ Đóng</button>
            </div>
        </div>
    </div>

    <!-- Character Profile Modal -->
    <div class="profile-modal" id="characterModal">
        <div class="profile-content">
            <div class="profile-avatar" id="characterAvatar">🧘</div>
            <h3 id="characterName">Tên nhân vật</h3>
            <div class="stars" id="characterStars">⭐⭐</div>
            <p id="characterBio">Thiền sinh mới bắt đầu hành trình tìm hiểu bản thân.</p>
            <div style="margin-top: 20px;">
                <button class="btn">🤝 Kết bạn</button>
                <button class="btn">💬 Nhắn tin</button>
                <button class="btn" style="background:#f44336; color:white;">🚫 Block</button>
            </div>
            <button class="btn" onclick="closeCharacterModal()" style="margin-top:10px;">❌ Đóng</button>
        </div>
    </div>

    <!-- Background Selector -->
    <div class="background-selector" id="backgroundSelector">
        <h3>🌸 Chọn nền thiền</h3>
        <div class="bg-options">
            <div class="bg-option" data-bg="garden" style="background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
            <div class="bg-option" data-bg="forest" style="background-image: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);"></div>
            <div class="bg-option" data-bg="mountain" style="background-image: linear-gradient(135deg, #2196f3 0%, #21cbf3 100%);"></div>
            <div class="bg-option" data-bg="sunset" style="background-image: linear-gradient(135deg, #ff9800 0%, #f44336 100%);"></div>
            <div class="bg-option" data-bg="night" style="background-image: linear-gradient(135deg, #673ab7 0%, #3f51b5 100%);"></div>
            <div class="bg-option" data-bg="zen" style="background-image: linear-gradient(135deg, #795548 0%, #8d6e63 100%);"></div>
        </div>
        <input type="file" id="customBackground" accept="image/*" style="margin: 10px 0;">
        <div>
            <button class="btn" onclick="applyBackground()">✅ Áp dụng</button>
            <button class="btn" onclick="closeBackgroundSelector()">❌ Đóng</button>
        </div>
    </div>

    <script>
        // People & Appearance emojis from Emojipedia
        const peopleEmojis = [
            '😀','😃','😄','😁','😆','😅','🤣','😂','🙂','🙃','😉','😊','😇','🥰','😍','🤩','😘','😗','☺️','😚','😙','🥲','😋','😛','😜','🤪','😝','🤑','🤗','🤭','🤫','🤔','🤐','🤨','😐','😑','😶','😏','😒','🙄','😬','🤥','😔','😪','🤤','😴','😷','🤒','🤕','🤢','🤮','🤧','🥵','🥶','🥴','😵','🤯','🤠','🥳','🥸','😎','🤓','🧐','😕','😟','🙁','☹️','😮','😯','😲','😳','🥺','😦','😧','😨','😰','😥','😢','😭','😱','😖','😣','😞','😓','😩','😫','🥱','😤','😡','😠','🤬','😈','👿','💀','☠️',
            '👶','🧒','👦','👧','🧑','👨','👩','🧓','👴','👵','👱','👱‍♂️','👱‍♀️','🧔','👨‍🦰','👨‍🦱','👨‍🦳','👨‍🦲','👩‍🦰','👩‍🦱','👩‍🦳','👩‍🦲','🙋','🙋‍♂️','🙋‍♀️','🙆','🙆‍♂️','🙆‍♀️','🙅','🙅‍♂️','🙅‍♀️','🤷','🤷‍♂️','🤷‍♀️','🤦','🤦‍♂️','🤦‍♀️','🙇','🙇‍♂️','🙇‍♀️','🧘','🧘‍♂️','🧘‍♀️','🤱','🤰','👸','🤴','👳','👳‍♂️','👳‍♀️','👲','🧕','🤵','🤵‍♂️','🤵‍♀️','👰','👰‍♂️','👰‍♀️','🤯','🥳','🤠','🤡','👻','👽','👾','🤖'
        ];

        function toggleMusicPanel() {
            const musicControls = document.querySelector('.music-controls');
            const toggleBtn = document.querySelector('.music-toggle');
            
            if (musicControls.style.display === 'none' || !musicControls.style.display) {
                musicControls.style.display = 'block';
                toggleBtn.textContent = '✖';
            } else {
                musicControls.style.display = 'none';
                toggleBtn.textContent = '♪';
            }
        }

        function updateYouTubeEmbed() {
            const urlInput = document.getElementById('youtubeUrl');
            const url = urlInput.value.trim();
            
            if (!url) return;
            
            // Extract video ID from YouTube URL
            let videoId = '';
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = url.match(regex);
            
            if (match) {
                videoId = match[1];
                const iframe = document.getElementById('ytplayer');
                iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=0&loop=1&playlist=${videoId}`;
                urlInput.value = '';
                alert('Đã cập nhật nhạc thành công!');
            } else {
                alert('URL YouTube không hợp lệ!');
            }
        }

        // Game state
        let gameState = {
            characters: new Map(),
            myCharacter: null,
            isMoving: false,
            isSitting: false,
            userName: '',
            meditationDays: 0,
            joinDate: new Date(),
            currentBackground: 'garden',
            selectedEmoji: '🧘',
            moveTarget: null
        };

        function loadUserData() {
            const saved = localStorage.getItem('mgoMeditationRoomV3') || '{}';
            const data = JSON.parse(saved);
            
            gameState.userName = data.userName || 'Thiền sinh mới';
            gameState.joinDate = new Date(data.joinDate || Date.now());
            gameState.meditationDays = data.meditationDays || 0;
            gameState.currentBackground = data.currentBackground || 'garden';
            gameState.selectedEmoji = data.selectedEmoji || '🧘';
            
            // Calculate achievement days
            const daysDiff = Math.floor((Date.now() - gameState.joinDate.getTime()) / (1000 * 60 * 60 * 24));
            gameState.meditationDays = Math.max(daysDiff, gameState.meditationDays);
            
            applyBackground();
        }

        function saveUserData() {
            const data = {
                userName: gameState.userName,
                joinDate: gameState.joinDate.toISOString(),
                meditationDays: gameState.meditationDays,
                currentBackground: gameState.currentBackground,
                selectedEmoji: gameState.selectedEmoji
            };
            localStorage.setItem('mgoMeditationRoomV3', JSON.stringify(data));
        }

        function createMyCharacter() {
            const character = document.createElement('div');
            character.className = 'character standing';
            character.style.left = '50%';
            character.style.top = '50%';
            character.style.transform = 'translate(-50%, -50%)';
            
            const body = document.createElement('div');
            body.className = 'character-body';
            body.textContent = gameState.selectedEmoji;
            body.style.fontSize = '48px';
            body.style.display = 'flex';
            body.style.alignItems = 'center';
            body.style.justifyContent = 'center';
            character.appendChild(body);
            
            // Add status indicator
            const status = document.createElement('div');
            status.className = 'character-status';
            status.textContent = gameState.userName;
            character.appendChild(status);
            
            character.onclick = () => showProfile();
            
            document.querySelector('.room-container').appendChild(character);
            gameState.myCharacter = character;
        }

        function addOtherCharacters() {
            // Add some demo characters with different emojis
            const demoCharacters = [
                { x: 20, y: 30, name: 'Minh An', emoji: '👨‍🦰', stars: 2 },
                { x: 80, y: 25, name: 'Thu Hà', emoji: '👩‍🦱', stars: 4 },
                { x: 15, y: 70, name: 'Đức Anh', emoji: '🧔', stars: 1 },
                { x: 85, y: 75, name: 'Linh Chi', emoji: '👩‍🦳', stars: 3 }
            ];
            
            demoCharacters.forEach((demo, index) => {
                const character = document.createElement('div');
                character.className = Math.random() > 0.5 ? 'character sitting meditating' : 'character standing';
                character.style.left = demo.x + '%';
                character.style.top = demo.y + '%';
                
                const body = document.createElement('div');
                body.className = 'character-body';
                body.textContent = demo.emoji;
                body.style.fontSize = '48px';
                body.style.display = 'flex';
                body.style.alignItems = 'center';
                body.style.justifyContent = 'center';
                character.appendChild(body);
                
                // Add status indicator
                const status = document.createElement('div');
                status.className = 'character-status';
                status.textContent = demo.name;
                character.appendChild(status);
                
                character.onclick = () => showCharacterProfile(demo);
                
                document.querySelector('.room-container').appendChild(character);
                gameState.characters.set(index, { element: character, data: demo });
                
                // Random chat for demo characters
                if (Math.random() > 0.7) {
                    setTimeout(() => {
                        const messages = ['Om...', 'Bình an...', '🕉️', 'Thiền định...', 'Hạnh phúc'];
                        showChatBubble(character, messages[Math.floor(Math.random() * messages.length)]);
                    }, Math.random() * 5000);
                }
            });
        }

        function setupRoomInteraction() {
            const roomContainer = document.getElementById('roomContainer');
            
            roomContainer.addEventListener('click', (e) => {
                if (gameState.isSitting) return;
                
                // Don't move if clicking on character or UI elements
                if (e.target.closest('.character') || e.target.closest('.controls') || 
                    e.target.closest('.music-controls') || e.target.closest('.chat-input') ||
                    e.target.closest('.music-toggle')) {
                    return;
                }
                
                const rect = roomContainer.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                
                moveCharacterTo(x, y);
                showMoveIndicator(e.clientX - rect.left, e.clientY - rect.top);
            });
        }

        function moveCharacterTo(x, y) {
            if (!gameState.myCharacter || gameState.isSitting) return;
            
            // Clamp positions to room boundaries
            x = Math.max(5, Math.min(95, x));
            y = Math.max(5, Math.min(95, y));
            
            gameState.moveTarget = { x, y };
            gameState.isMoving = true;
            gameState.myCharacter.classList.add('walking');
            
            // Animate movement
            gameState.myCharacter.style.transition = 'left 1s ease-out, top 1s ease-out';
            gameState.myCharacter.style.left = x + '%';
            gameState.myCharacter.style.top = y + '%';
            
            // Stop walking animation after movement
            setTimeout(() => {
                gameState.isMoving = false;
                gameState.myCharacter.classList.remove('walking');
                gameState.myCharacter.style.transition = '';
                gameState.moveTarget = null;
            }, 1000);
        }

        function showMoveIndicator(x, y) {
            const indicator = document.createElement('div');
            indicator.className = 'move-indicator';
            indicator.style.left = (x - 10) + 'px';
            indicator.style.top = (y - 10) + 'px';
            
            document.querySelector('.room-container').appendChild(indicator);
            
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.remove();
                }
            }, 1000);
        }

        function sitDown() {
            if (!gameState.isSitting) {
                gameState.isSitting = true;
                gameState.myCharacter.classList.remove('standing', 'walking');
                gameState.myCharacter.classList.add('sitting', 'meditating');
                updateButtonStates();
                
                // Increment meditation counter
                gameState.meditationDays++;
                saveUserData();
            }
        }

        function standUp() {
            if (gameState.isSitting) {
                gameState.isSitting = false;
                gameState.myCharacter.classList.remove('sitting', 'meditating');
                gameState.myCharacter.classList.add('standing');
                updateButtonStates();
            }
        }

        function updateButtonStates() {
            const standBtn = document.getElementById('standBtn');
            const sitBtn = document.getElementById('sitBtn');
            
            if (gameState.isSitting) {
                standBtn.classList.add('active');
                sitBtn.classList.remove('active');
            } else {
                standBtn.classList.remove('active');
                sitBtn.classList.add('active');
            }
        }

        function sendMessage() {
            const input = document.getElementById('chatMessage');
            const message = input.value.trim();
            
            if (message && message.length <= 160) {
                showChatBubble(gameState.myCharacter, message);
                input.value = '';
            }
        }

        function showChatBubble(character, message) {
            // Remove existing bubble
            const existingBubble = character.querySelector('.chat-bubble');
            if (existingBubble) {
                existingBubble.remove();
            }
            
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble';
            bubble.textContent = message;
            
            // Calculate width based on message length but respect character width
            const charWidth = character.offsetWidth;
            bubble.style.maxWidth = charWidth + 20 + 'px';
            bubble.style.minWidth = charWidth + 'px';
            
            character.appendChild(bubble);
            
            setTimeout(() => {
                if (bubble.parentNode) {
                    bubble.remove();
                }
            }, 5000);
        }

        function showProfile() {
            const modal = document.getElementById('profileModal');
            
            document.getElementById('userName').value = gameState.userName;
            document.getElementById('profileAvatar').textContent = gameState.selectedEmoji;
            
            // Update achievements
            const weeks = Math.floor(gameState.meditationDays / 7);
            const stars = Math.min(weeks, 10);
            document.getElementById('achievementStars').textContent = '⭐'.repeat(stars) || '🌱';
            
            let achievementText = 'Thiền sinh mới bắt đầu';
            if (weeks >= 1) achievementText = 'Kiên trì 1 tuần';
            if (weeks >= 2) achievementText = 'Thiền sinh tận tâm';
            if (weeks >= 4) achievementText = 'Thiền sư nhỏ';
            if (weeks >= 8) achievementText = 'Bậc thầy thiền định';
            if (weeks >= 16) achievementText = 'Enlightened Master';
            
            document.getElementById('achievementText').textContent = achievementText;
            
            modal.style.display = 'flex';
        }

        function closeProfile() {
            document.getElementById('profileModal').style.display = 'none';
            document.getElementById('emojiSelector').classList.add('hidden');
        }

        function saveProfile() {
            gameState.userName = document.getElementById('userName').value || 'Thiền sinh mới';
            
            // Update character status
            if (gameState.myCharacter) {
                const status = gameState.myCharacter.querySelector('.character-status');
                if (status) {
                    status.textContent = gameState.userName;
                }
                
                // Update character emoji
                const body = gameState.myCharacter.querySelector('.character-body');
                if (body) {
                    body.textContent = gameState.selectedEmoji;
                }
            }
            
            saveUserData();
            closeProfile();
        }

        function showEmojiSelector() {
            const selector = document.getElementById('emojiSelector');
            selector.innerHTML = '';
            
            peopleEmojis.forEach(emoji => {
                const option = document.createElement('div');
                option.className = 'emoji-option';
                option.textContent = emoji;
                if (emoji === gameState.selectedEmoji) {
                    option.classList.add('selected');
                }
                option.onclick = () => {
                    // Remove previous selection
                    selector.querySelectorAll('.emoji-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    gameState.selectedEmoji = emoji;
                    document.getElementById('profileAvatar').textContent = emoji;
                };
                selector.appendChild(option);
            });
            
            selector.classList.toggle('hidden');
        }

        function showCharacterProfile(characterData) {
            const modal = document.getElementById('characterModal');
            
            document.getElementById('characterAvatar').textContent = characterData.emoji;
            document.getElementById('characterName').textContent = characterData.name;
            document.getElementById('characterStars').textContent = '⭐'.repeat(characterData.stars);
            
            const bios = [
                'Thiền sinh mới bắt đầu hành trình tìm hiểu bản thân.',
                'Người yêu thiên nhiên và tìm kiếm sự bình an nội tâm.',
                'Thiền sư trẻ với niềm đam mê chia sẻ trí tuệ.',
                'Bậc thầy thiền định với nhiều năm kinh nghiệm.'
            ];
            
            document.getElementById('characterBio').textContent = bios[Math.min(characterData.stars - 1, 3)];
            modal.style.display = 'flex';
        }

        function closeCharacterModal() {
            document.getElementById('characterModal').style.display = 'none';
        }

        function setupBackgroundOptions() {
            const backgrounds = {
                garden: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                forest: 'linear-gradient(135deg, #4caf50 0%, #8bc34a 100%)',
                mountain: 'linear-gradient(135deg, #2196f3 0%, #21cbf3 100%)',
                sunset: 'linear-gradient(135deg, #ff9800 0%, #f44336 100%)',
                night: 'linear-gradient(135deg, #673ab7 0%, #3f51b5 100%)',
                zen: 'linear-gradient(135deg, #795548 0%, #8d6e63 100%)'
            };
            
            const options = document.querySelectorAll('.bg-option');
            options.forEach(option => {
                const bg = option.dataset.bg;
                option.style.backgroundImage = backgrounds[bg];
                option.onclick = () => {
                    options.forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    gameState.currentBackground = bg;
                };
            });
            
            // Custom background upload
            document.getElementById('customBackground').onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        gameState.currentBackground = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };
        }

        function showBackgroundSelector() {
            document.getElementById('backgroundSelector').style.display = 'block';
        }

        function closeBackgroundSelector() {
            document.getElementById('backgroundSelector').style.display = 'none';
        }

        function applyBackground() {
            const container = document.querySelector('.room-background');
            
            if (gameState.currentBackground.startsWith('data:')) {
                // Custom uploaded image
                container.style.backgroundImage = `url('${gameState.currentBackground}')`;
            } else {
                // Predefined backgrounds
                const backgrounds = {
                    garden: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    forest: 'linear-gradient(135deg, #4caf50 0%, #8bc34a 100%)',
                    mountain: 'linear-gradient(135deg, #2196f3 0%, #21cbf3 100%)',
                    sunset: 'linear-gradient(135deg, #ff9800 0%, #f44336 100%)',
                    night: 'linear-gradient(135deg, #673ab7 0%, #3f51b5 100%)',
                    zen: 'linear-gradient(135deg, #795548 0%, #8d6e63 100%)'
                };
                container.style.backgroundImage = backgrounds[gameState.currentBackground];
            }
            
            saveUserData();
            closeBackgroundSelector();
        }

        // Initialize
        function init() {
            loadUserData();
            setupBackgroundOptions();
            createMyCharacter();
            addOtherCharacters();
            setupRoomInteraction();
            updateButtonStates();
            
            // Auto-save every 30 seconds
            setInterval(saveUserData, 30000);
        }

        // Weather effects
        function createWeatherEffect() {
            if (Math.random() > 0.9) {
                const effects = ['rain', 'snow', 'petals'];
                const effect = effects[Math.floor(Math.random() * effects.length)];
                
                for (let i = 0; i < 20; i++) {
                    setTimeout(() => {
                        createWeatherParticle(effect);
                    }, i * 100);
                }
            }
        }

        function createWeatherParticle(type) {
            const particle = document.createElement('div');
            particle.style.position = 'absolute';
            particle.style.pointerEvents = 'none';
            particle.style.zIndex = '2';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.top = '-10px';
            
            switch(type) {
                case 'rain':
                    particle.textContent = '💧';
                    break;
                case 'snow':
                    particle.textContent = '❄️';
                    break;
                case 'petals':
                    particle.textContent = '🌸';
                    break;
            }
            
            particle.style.fontSize = (Math.random() * 10 + 10) + 'px';
            particle.style.animation = `fall ${Math.random() * 3 + 2}s linear forwards`;
            
            document.querySelector('.room-container').appendChild(particle);
            
            setTimeout(() => {
                if (particle.parentNode) {
                    particle.remove();
                }
            }, 5000);
        }

        // Initialize on load
        window.onload = init;

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 's' || e.key === 'S') {
                if (gameState.isSitting) {
                    standUp();
                } else {
                    sitDown();
                }
            }
            if (e.key === 'Enter' && document.activeElement.id === 'chatMessage') {
                sendMessage();
            }
        });

        // Add touch support for mobile
        let touchStartX, touchStartY;
        
        document.addEventListener('touchstart', function(e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });
        
        document.addEventListener('touchend', function(e) {
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            
            // Check if it's a tap (not a swipe)
            const deltaX = Math.abs(touchEndX - touchStartX);
            const deltaY = Math.abs(touchEndY - touchStartY);
            
            if (deltaX < 10 && deltaY < 10) {
                // Trigger click event for tap
                const clickEvent = new MouseEvent('click', {
                    clientX: touchEndX,
                    clientY: touchEndY,
                    bubbles: true
                });
                e.target.dispatchEvent(clickEvent);
            }
        });

        // Periodic character animations for demo characters
        setInterval(() => {
            gameState.characters.forEach((characterObj) => {
                const character = characterObj.element;
                
                // Random chance for demo characters to chat
                if (Math.random() > 0.95) {
                    const messages = [
                        'Om mani padme hum 🕉️', 
                        'Bình an trong tâm 🙏', 
                        'Hạnh phúc thật sự ✨',
                        'Thiền định mỗi ngày 🧘',
                        'Cảm ơn vũ trụ 🌌',
                        'Yêu thương vô bờ ❤️'
                    ];
                    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                    showChatBubble(character, randomMessage);
                }
                
                // Random chance to change meditation state
                if (Math.random() > 0.98) {
                    if (character.classList.contains('sitting')) {
                        character.classList.remove('sitting', 'meditating');
                        character.classList.add('standing');
                    } else {
                        character.classList.remove('standing');
                        character.classList.add('sitting', 'meditating');
                    }
                }
            });
        }, 2000);

        // Auto-save meditation progress
        setInterval(() => {
            if (gameState.isSitting) {
                gameState.meditationDays += 0.01; // Small increment for active meditation
                
                // Show meditation benefits occasionally
                if (Math.random() > 0.95) {
                    const benefits = [
                        'Tâm trí đang thư giãn... 😌',
                        'Căng thẳng đang tan biến... 🌸',
                        'Năng lượng tích cực tăng... ✨',
                        'Sự tập trung được cải thiện... 🎯',
                        'Bình an nội tâm lan tỏa... 🕊️'
                    ];
                    showChatBubble(gameState.myCharacter, benefits[Math.floor(Math.random() * benefits.length)]);
                }
            }
        }, 10000); // Every 10 seconds during meditation

        // Start weather effects
        setInterval(createWeatherEffect, 30000); // Every 30 seconds

        // Performance optimization: Pause animations when tab is not visible
        document.addEventListener('visibilitychange', function() {
            const characters = document.querySelectorAll('.character');
            characters.forEach(char => {
                if (document.hidden) {
                    char.style.animationPlayState = 'paused';
                } else {
                    char.style.animationPlayState = 'running';
                }
            });
        });

        // Easter eggs
        let konamiCode = [];
        const konamiSequence = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'KeyB', 'KeyA'];
        
        document.addEventListener('keydown', function(e) {
            konamiCode.push(e.code);
            if (konamiCode.length > konamiSequence.length) {
                konamiCode.shift();
            }
            
            if (JSON.stringify(konamiCode) === JSON.stringify(konamiSequence)) {
                // Easter egg: Enlightenment mode
                showChatBubble(gameState.myCharacter, '🌟 ENLIGHTENMENT ACHIEVED! 🌟');
                gameState.myCharacter.style.filter = 'drop-shadow(0 0 30px gold) hue-rotate(45deg)';
                setTimeout(() => {
                    gameState.myCharacter.style.filter = '';
                }, 5000);
                konamiCode = [];
            }
        });
    </script>
</body>
</html>
