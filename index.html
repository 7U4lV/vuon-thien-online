<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meditation Room V3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #1a1a2e;
        }

        .room-container {
            width: min(100vw, calc(100vh * 9/16));
            height: min(100vh, calc(100vw * 16/9));
            position: relative;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: cover;
            background-position: center;
            transition: background 0.5s ease;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .room-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 1600"><defs><linearGradient id="skyGrad" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:%23e8f4fd;stop-opacity:1" /><stop offset="70%" style="stop-color:%23b8e6b8;stop-opacity:1" /><stop offset="100%" style="stop-color:%2366bb6a;stop-opacity:1" /></linearGradient></defs><rect width="900" height="1600" fill="url(%23skyGrad)"/><circle cx="1400" cy="150" r="80" fill="%23ffeb3b" opacity="0.9"/><ellipse cx="200" cy="750" rx="150" ry="80" fill="%234caf50"/><ellipse cx="600" cy="780" rx="200" ry="100" fill="%234caf50"/><ellipse cx="1200" cy="730" rx="180" ry="90" fill="%234caf50"/><path d="M0,800 Q400,700 800,750 T1600,800 L1600,900 L0,900 Z" fill="%23388e3c"/><circle cx="300" cy="200" r="4" fill="%23fff" opacity="0.8"/><circle cx="800" cy="120" r="3" fill="%23fff" opacity="0.6"/><circle cx="1300" cy="250" r="5" fill="%23fff" opacity="0.7"/></svg>');
            background-size: cover;
            background-position: center;
            z-index: 1;
        }

        .character {
            position: absolute;
            width: 64px;
            height: 96px;
            cursor: pointer;
            transition: transform 0.3s ease;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }

        .character:hover {
            transform: scale(1.05);
        }

        .character.walking {
            animation: walk 0.6s infinite;
        }

        .character.sitting {
            cursor: default;
        }

        .character.meditating {
            animation: meditate 3s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.6));
        }

        @keyframes walk {
            0%, 100% { transform: translateY(0px) scaleX(1); }
            25% { transform: translateY(-2px) scaleX(0.98); }
            50% { transform: translateY(0px) scaleX(1); }
            75% { transform: translateY(-1px) scaleX(0.98); }
        }

        @keyframes meditate {
            0%, 100% { 
                filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.4));
                transform: scale(1);
            }
            50% { 
                filter: drop-shadow(0 0 25px rgba(255, 215, 0, 0.8));
                transform: scale(1.02);
            }
        }

        .character-body {
            width: 100%;
            height: 100%;
            position: relative;
            background: transparent;
        }

        .character-head {
            position: absolute;
            top: 8px;
            left: 20px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            z-index: 11;
        }

        .character.standing .character-body {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 96"><defs><radialGradient id="aura" cx="50%" cy="50%" r="60%"><stop offset="0%" style="stop-color:rgba(255,215,0,0);stop-opacity:0" /><stop offset="100%" style="stop-color:rgba(255,215,0,0);stop-opacity:0" /></radialGradient></defs><ellipse cx="32" cy="85" rx="15" ry="8" fill="rgba(0,0,0,0.2)"/><rect x="26" y="32" width="12" height="20" rx="6" fill="%234a90e2"/><rect x="24" y="52" width="16" height="24" rx="8" fill="%232c3e50"/><rect x="18" y="36" width="6" height="16" rx="3" fill="%23fdbcb4"/><rect x="40" y="36" width="6" height="16" rx="3" fill="%23fdbcb4"/><ellipse cx="26" cy="80" rx="4" ry="8" fill="%23fdbcb4"/><ellipse cx="38" cy="80" rx="4" ry="8" fill="%23fdbcb4"/><ellipse cx="26" cy="88" rx="6" ry="4" fill="%23654321"/><ellipse cx="38" cy="88" rx="6" ry="4" fill="%23654321"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .character.sitting .character-body {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 96"><defs><radialGradient id="aura" cx="50%" cy="50%" r="80%"><stop offset="0%" style="stop-color:rgba(255,215,0,0.3);stop-opacity:0.6" /><stop offset="100%" style="stop-color:rgba(255,215,0,0);stop-opacity:0" /></radialGradient></defs><circle cx="32" cy="48" r="45" fill="url(%23aura)"/><ellipse cx="32" cy="85" rx="20" ry="10" fill="rgba(0,0,0,0.2)"/><rect x="26" y="37" width="12" height="18" rx="6" fill="%234a90e2"/><circle cx="32" cy="65" r="8" fill="%232c3e50"/><ellipse cx="24" cy="72" rx="6" ry="4" fill="%232c3e50"/><ellipse cx="40" cy="72" rx="6" ry="4" fill="%232c3e50"/><ellipse cx="22" cy="76" rx="4" ry="3" fill="%23654321"/><ellipse cx="42" cy="76" rx="4" ry="3" fill="%23654321"/><circle cx="28" cy="40" r="6" fill="%23fdbcb4"/><circle cx="36" cy="40" r="6" fill="%23fdbcb4"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .chat-bubble {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.95);
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 64px;
            width: auto;
            min-width: 40px;
            word-wrap: break-word;
            word-break: break-word;
            font-size: 10px;
            line-height: 1.2;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 15;
            animation: chatFadeInOut 5s ease-in-out;
            text-align: center;
            border: 2px solid rgba(255,255,255,0.8);
        }

        .chat-bubble::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid rgba(255,255,255,0.95);
        }

        @keyframes chatFadeInOut {
            0%, 100% { opacity: 0; transform: translateX(-50%) translateY(10px) scale(0.8); }
            10%, 90% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
        }

        .controls {
            position: absolute;
            top: 5%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 6px 9px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            min-width: 40px;
        }

        .btn:hover {
            background: rgba(255,255,255,1);
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }

        .btn.active {
            background: #4caf50;
            color: white;
        }

        .music-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            z-index: 101;
            transition: all 0.3s ease;
        }

        .music-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .music-toggle.open {
            right: 20px;
            left: auto;
        }

        .music-controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            max-width: 300px;
            display: none;
        }

        .music-controls.show {
            display: block;
        }

        .chat-input {
            position: fixed;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            gap: 10px;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .chat-input input {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            width: 200px;
            background: rgba(255,255,255,0.8);
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        .chat-input .btn {
            padding: 8px 12px;
            font-size: 11px;
        }

        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .profile-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            max-height: 80vh;
            overflow-y: auto;
        }

        .profile-avatar {
            width: 80px;
            height: 120px;
            margin: 0 auto 20px;
            border: 3px solid #ddd;
            border-radius: 10px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            position: relative;
        }

        .profile-avatar:hover {
            border-color: #4caf50;
        }

        .stars {
            color: #ffd700;
            font-size: 20px;
            margin: 10px 0;
        }

        .emoji-selector {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 300;
            align-items: center;
            justify-content: center;
        }

        .emoji-grid {
            background: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 400px;
            max-height: 500px;
            overflow-y: auto;
        }

        .emoji-category {
            margin-bottom: 15px;
        }

        .emoji-category h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .emoji-options {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
        }

        .emoji-option {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 5px;
            font-size: 20px;
            transition: background 0.3s ease;
        }

        .emoji-option:hover {
            background: #f0f0f0;
            transform: scale(1.1);
        }

        .achievement-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            margin: 3px;
        }

        .hidden {
            display: none !important;
        }

        .background-selector {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 15px;
            z-index: 150;
            display: none;
            backdrop-filter: blur(10px);
        }

        .bg-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 15px 0;
        }

        .bg-option {
            width: 80px;
            height: 60px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            background-size: cover;
            background-position: center;
        }

        .bg-option:hover, .bg-option.selected {
            border-color: #4caf50;
            transform: scale(1.05);
        }

        .character-status {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            white-space: nowrap;
        }

        .move-indicator {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid #4caf50;
            border-radius: 50%;
            pointer-events: none;
            z-index: 5;
            animation: moveIndicator 1s ease-out;
        }

        @keyframes moveIndicator {
            0% { 
                transform: scale(0.5);
                opacity: 1;
                border-width: 4px;
            }
            100% { 
                transform: scale(1.5);
                opacity: 0;
                border-width: 1px;
            }
        }

        @keyframes fall {
            to {
                transform: translateY(calc(100vh + 50px)) rotate(360deg);
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            .controls {
                gap: 3px;
            }
            
            .btn {
                padding: 5px 8px;
                font-size: 9px;
                min-width: 35px;
            }
            
            .music-controls {
                max-width: 250px;
                padding: 10px;
            }
            
            .chat-input input {
                width: 150px;
                padding: 6px 12px;
                font-size: 11px;
            }

            .chat-input .btn {
                padding: 6px 10px;
                font-size: 10px;
            }

            .music-toggle {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }

        @media (orientation: portrait) {
            .controls {
                top: 3%;
            }
            
            .btn {
                padding: 4px 7px;
                font-size: 8px;
                min-width: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="room-container" id="roomContainer">
        <div class="room-background"></div>
        
        <div class="controls">
            <button class="btn" id="standBtn" onclick="standUp()">üö∂ ƒêI</button>
            <button class="btn" id="sitBtn" onclick="sitDown()">üßò NG·ªíI THI·ªÄN</button>
            <button class="btn" onclick="showProfile()">üë§ Profile</button>
            <button class="btn" onclick="showBackgroundSelector()">üé® ƒê·ªïi n·ªÅn</button>
        </div>

        <button class="music-toggle" id="musicToggle" onclick="toggleMusicPanel()">‚ô™</button>

        <div class="music-controls" id="musicControls">
            <h4>üéµ Nh·∫°c thi·ªÅn</h4>
            <iframe id="ytplayer" type="text/html" width="1" height="0.5625"
                src="https://www.youtube.com/embed/M7lc1UVf-VE?autoplay=1&controls=0&loop=1"
                frameborder="0" allowfullscreen style="display: none;"></iframe>
            <input type="text" id="youtubeEmbed" placeholder="D√°n m√£ embed YouTube" 
                style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px;">
            <button class="btn" onclick="updateYouTubeEmbed()" style="width: 100%; margin: 5px 0;">üéµ C·∫≠p nh·∫≠t nh·∫°c</button>
        </div>

        <div class="chat-input">
            <input type="text" id="chatMessage" placeholder="Nh·∫≠p tin nh·∫Øn..." maxlength="160" onkeypress="if(event.key==='Enter') sendMessage()">
            <button class="btn" onclick="sendMessage()">üí¨ G·ª≠i</button>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-content">
            <h3>Profile thi·ªÅn sinh</h3>
            <div class="profile-avatar" id="profileAvatar" onclick="showEmojiSelector()">
                <div class="character-head" id="profileHead">üòä</div>
            </div>
            <input type="text" id="userName" placeholder="T√™n c·ªßa b·∫°n" style="width:100%; padding:10px; margin:10px 0; border:1px solid #ddd; border-radius:8px;">
            
            <div class="stars" id="achievementStars">‚≠ê‚≠ê‚≠ê</div>
            <div id="achievementText">Thi·ªÅn sinh t·∫≠n t√¢m - 3 tu·∫ßn ki√™n tr√¨</div>
            
            <div class="achievement-badge">Ng∆∞·ªùi m·ªõi</div>
            <div class="achievement-badge">Ki√™n tr√¨ 1 tu·∫ßn</div>
            <div class="achievement-badge">Thi·ªÅn s∆∞ nh·ªè</div>
            
            <div style="margin-top: 20px;">
                <button class="btn" onclick="saveProfile()">üíæ L∆∞u</button>
                <button class="btn" onclick="closeProfile()">‚ùå ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Character Profile Modal -->
    <div class="profile-modal" id="characterModal">
        <div class="profile-content">
            <div class="profile-avatar" id="characterAvatar">
                <div class="character-head" id="characterHead">üòä</div>
            </div>
            <h3 id="characterName">T√™n nh√¢n v·∫≠t</h3>
            <div class="stars" id="characterStars">‚≠ê‚≠ê</div>
            <p id="characterBio">Thi·ªÅn sinh m·ªõi b·∫Øt ƒë·∫ßu h√†nh tr√¨nh t√¨m hi·ªÉu b·∫£n th√¢n.</p>
            <div style="margin-top: 20px;">
                <button class="btn">ü§ù K·∫øt b·∫°n</button>
                <button class="btn">üí¨ Nh·∫Øn tin</button>
                <button class="btn" style="background:#f44336; color:white;">üö´ Block</button>
            </div>
            <button class="btn" onclick="closeCharacterModal()" style="margin-top:10px;">‚ùå ƒê√≥ng</button>
        </div>
    </div>

    <!-- Background Selector -->
    <div class="background-selector" id="backgroundSelector">
        <h3>üå∏ Ch·ªçn n·ªÅn thi·ªÅn</h3>
        <div class="bg-options">
            <div class="bg-option" data-bg="garden" style="background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
            <div class="bg-option" data-bg="forest" style="background-image: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);"></div>
            <div class="bg-option" data-bg="mountain" style="background-image: linear-gradient(135deg, #2196f3 0%, #21cbf3 100%);"></div>
            <div class="bg-option" data-bg="sunset" style="background-image: linear-gradient(135deg, #ff9800 0%, #f44336 100%);"></div>
            <div class="bg-option" data-bg="night" style="background-image: linear-gradient(135deg, #673ab7 0%, #3f51b5 100%);"></div>
            <div class="bg-option" data-bg="zen" style="background-image: linear-gradient(135deg, #795548 0%, #8d6e63 100%);"></div>
        </div>
        <input type="file" id="customBackground" accept="image/*" style="margin: 10px 0;">
        <div>
            <button class="btn" onclick="applyBackground()">‚úÖ √Åp d·ª•ng</button>
            <button class="btn" onclick="closeBackgroundSelector()">‚ùå ƒê√≥ng</button>
        </div>
    </div>

    <!-- Emoji Selector -->
    <div class="emoji-selector" id="emojiSelector">
        <div class="emoji-grid">
            <h3>Ch·ªçn avatar emoji</h3>
            
            <div class="emoji-category">
                <h4>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Ng∆∞·ªùi</h4>
                <div class="emoji-options" id="peopleEmojis"></div>
            </div>
            
            <div class="emoji-category">
                <h4>üòä Bi·ªÉu c·∫£m</h4>
                <div class="emoji-options" id="emotionEmojis"></div>
            </div>
            
            <div class="emoji-category">
                <h4>üßò Thi·ªÅn ƒë·ªãnh</h4>
                <div class="emoji-options" id="meditationEmojis"></div>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="btn" onclick="closeEmojiSelector()">‚ùå ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <script>
        // Emoji collections
        const emojiCollections = {
            people: [
                'üë§', 'üë•', 'üë®', 'üë©', 'üßë', 'üë¥', 'üëµ', 'üë∂', 'üë¶', 'üëß',
                'üë®‚Äçü¶≥', 'üë©‚Äçü¶≥', 'üë®‚Äçü¶≤', 'üë©‚Äçü¶≤', 'üë®‚Äçü¶±', 'üë©‚Äçü¶±', 'üë®‚Äçü¶∞', 'üë©‚Äçü¶∞',
                'üë±‚Äç‚ôÇÔ∏è', 'üë±‚Äç‚ôÄÔ∏è', 'üßî', 'üë®‚Äç‚öïÔ∏è', 'üë©‚Äç‚öïÔ∏è', 'üë®‚Äçüéì', 'üë©‚Äçüéì', 'üë®‚Äçüè´', 'üë©‚Äçüè´',
                'üë®‚Äçüíº', 'üë©‚Äçüíº', 'üë®‚Äçüî¨', 'üë©‚Äçüî¨', 'üë®‚Äçüíª', 'üë©‚Äçüíª', 'üë®‚Äçüé®', 'üë©‚Äçüé®'
            ],
            emotions: [
                'üòä', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', '‚ò∫Ô∏è', 'üòö', 'üòô', 'ü§ó',
                'ü§î', 'ü§´', 'ü§≠', 'üßê', 'üòé', 'ü§ì', 'üòá', 'üò¥', 'üò™', 'ü§§',
                'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î'
            ],
            meditation: [
                'üßò', 'üßò‚Äç‚ôÇÔ∏è', 'üßò‚Äç‚ôÄÔ∏è', 'üïâÔ∏è', '‚òØÔ∏è', 'üôè', 'ü§≤', 'üëê', 'üôå', '‚ú®',
                'üå∏', 'üå∫', 'üåª', 'üåº', 'üå∑', 'ü™∑', 'üçÉ', '‚òòÔ∏è', 'üåø', 'üå±'
            ]
        };

        // Game state
        let gameState = {
            characters: new Map(),
            myCharacter: null,
            isMoving: false,
            isSitting: false,
            userName: '',
            meditationDays: 0,
            joinDate: new Date(),
            currentBackground: 'garden',
            selectedEmoji: 'üòä',
            moveTarget: null,
            musicPanelOpen: false
        };

        // Initialize
        function init() {
            loadUserData();
            setupEmojiSelector();
            setupBackgroundOptions();
            createMyCharacter();
            addOtherCharacters();
            setupRoomInteraction();
            updateButtonStates();
            
            // Auto-save every 30 seconds
            setInterval(saveUserData, 30000);
        }

        function loadUserData() {
            const saved = localStorage.getItem('meditationRoomV3') || '{}';
            const data = JSON.parse(saved);
            
            gameState.userName = data.userName || 'Thi·ªÅn sinh m·ªõi';
            gameState.joinDate = new Date(data.joinDate || Date.now());
            gameState.meditationDays = data.meditationDays || 0;
            gameState.currentBackground = data.currentBackground || 'garden';
            gameState.selectedEmoji = data.selectedEmoji || 'üòä';
            
            // Calculate achievement days
            const daysDiff = Math.floor((Date.now() - gameState.joinDate.getTime()) / (1000 * 60 * 60 * 24));
            gameState.meditationDays = Math.max(daysDiff, gameState.meditationDays);
            
            applyBackground();
        }

        function saveUserData() {
            const data = {
                userName: gameState.userName,
                joinDate: gameState.joinDate.toISOString(),
                meditationDays: gameState.meditationDays,
                currentBackground: gameState.currentBackground,
                selectedEmoji: gameState.selectedEmoji
            };
            localStorage.setItem('meditationRoomV3', JSON.stringify(data));
        }

        function setupEmojiSelector() {
            // Setup people emojis
            const peopleContainer = document.getElementById('peopleEmojis');
            emojiCollections.people.forEach(emoji => {
                const option = document.createElement('div');
                option.className = 'emoji-option';
                option.textContent = emoji;
                option.onclick = () => selectEmoji(emoji);
                peopleContainer.appendChild(option);
            });

            // Setup emotion emojis
            const emotionContainer = document.getElementById('emotionEmojis');
            emojiCollections.emotions.forEach(emoji => {
                const option = document.createElement('div');
                option.className = 'emoji-option';
                option.textContent = emoji;
                option.onclick = () => selectEmoji(emoji);
                emotionContainer.appendChild(option);
            });

            // Setup meditation emojis
            const meditationContainer = document.getElementById('meditationEmojis');
            emojiCollections.meditation.forEach(emoji => {
                const option = document.createElement('div');
                option.className = 'emoji-option';
                option.textContent = emoji;
                option.onclick = () => selectEmoji(emoji);
                meditationContainer.appendChild(option);
            });
        }

        function selectEmoji(emoji) {
            gameState.selectedEmoji = emoji;
            updateCharacterHead();
            closeEmojiSelector();
        }

        function showEmojiSelector() {
            document.getElementById('emojiSelector').style.display = 'flex';
        }

        function closeEmojiSelector() {
            document.getElementById('emojiSelector').style.display = 'none';
        }

        function updateCharacterHead() {
            if (gameState.myCharacter) {
                const head = gameState.myCharacter.querySelector('.character-head');
                if (head) {
                    head.textContent = gameState.selectedEmoji;
                }
            }

            // Update profile avatar
            const profileHead = document.getElementById('profileHead');
            if (profileHead) {
                profileHead.textContent = gameState.selectedEmoji;
            }
        }

        function toggleMusicPanel() {
            const panel = document.getElementById('musicControls');
            const toggle = document.getElementById('musicToggle');
            
            gameState.musicPanelOpen = !gameState.musicPanelOpen;
            
            if (gameState.musicPanelOpen) {
                panel.classList.add('show');
                toggle.classList.add('open');
                toggle.textContent = '‚úñ';
            } else {
                panel.classList.remove('show');
                toggle.classList.remove('open');
                toggle.textContent = '‚ô™';
            }
        }

        function updateYouTubeEmbed() {
            const embedInput = document.getElementById('youtubeEmbed');
            const iframe = document.getElementById('ytplayer');
            const embedCode = embedInput.value.trim();
            
            if (embedCode) {
                // Extract YouTube URL from embed code or direct URL
                let videoUrl = embedCode;
                
                // If it's a full embed code, extract the src
                if (embedCode.includes('<iframe')) {
                    const srcMatch = embedCode.match(/src="([^"]+)"/);
                    if (srcMatch) {
                        videoUrl = srcMatch[1];
                    }
                }
                
                // If it's a YouTube watch URL, convert to embed
                if (videoUrl.includes('youtube.com/watch')) {
                    const videoId = videoUrl.match(/v=([^&]+)/);
                    if (videoId) {
                        videoUrl = `https://www.youtube.com/embed/${videoId[1]}?autoplay=1&controls=0&loop=1`;
                    }
                } else if (videoUrl.includes('youtu.be/')) {
                    const videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
                    videoUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=0&loop=1`;
                }
                
                iframe.src = videoUrl;
                embedInput.value = '';
                
                // Show success message
                showChatBubble(gameState.myCharacter, 'üéµ ƒê√£ c·∫≠p nh·∫≠t nh·∫°c!');
            }
        }

        function createMyCharacter() {
            const character = document.createElement('div');
            character.className = 'character standing';
            character.style.left = '50%';
            character.style.top = '50%';
            character.style.transform = 'translate(-50%, -50%)';
            
            const body = document.createElement('div');
            body.className = 'character-body';
            character.appendChild(body);
            
            // Add emoji head
            const head = document.createElement('div');
            head.className = 'character-head';
            head.textContent = gameState.selectedEmoji;
            character.appendChild(head);
            
            // Add status indicator
            const status = document.createElement('div');
            status.className = 'character-status';
            status.textContent = gameState.userName;
            character.appendChild(status);
            
            character.onclick = () => showProfile();
            
            document.querySelector('.room-container').appendChild(character);
            gameState.myCharacter = character;
        }

        function addOtherCharacters() {
            // Add some demo characters
            const demoCharacters = [
                { x: 20, y: 30, name: 'Minh An', stars: 2, emoji: 'üë®' },
                { x: 80, y: 25, name: 'Thu H√†', stars: 4, emoji: 'üë©' },
                { x: 15, y: 70, name: 'ƒê·ª©c Anh', stars: 1, emoji: 'üßë' },
                { x: 85, y: 75, name: 'Linh Chi', stars: 3, emoji: 'üë©‚Äçü¶≥' }
            ];
            
            demoCharacters.forEach((demo, index) => {
                const character = document.createElement('div');
                character.className = Math.random() > 0.5 ? 'character sitting meditating' : 'character standing';
                character.style.left = demo.x + '%';
                character.style.top = demo.y + '%';
                
                const body = document.createElement('div');
                body.className = 'character-body';
                character.appendChild(body);
                
                // Add emoji head
                const head = document.createElement('div');
                head.className = 'character-head';
                head.textContent = demo.emoji;
                character.appendChild(head);
                
                // Add status indicator
                const status = document.createElement('div');
                status.className = 'character-status';
                status.textContent = demo.name;
                character.appendChild(status);
                
                character.onclick = () => showCharacterProfile(demo);
                
                document.querySelector('.room-container').appendChild(character);
                gameState.characters.set(index, { element: character, data: demo });
                
                // Random chat for demo characters
                if (Math.random() > 0.7) {
                    setTimeout(() => {
                        const messages = ['Om...', 'B√¨nh an...', 'üïâÔ∏è', 'Thi·ªÅn ƒë·ªãnh...', 'H·∫°nh ph√∫c'];
                        showChatBubble(character, messages[Math.floor(Math.random() * messages.length)]);
                    }, Math.random() * 5000);
                }
            });
        }

        function setupRoomInteraction() {
            const roomContainer = document.getElementById('roomContainer');
            
            roomContainer.addEventListener('click', (e) => {
                if (gameState.isSitting) return;
                
                // Don't move if clicking on character or UI elements
                if (e.target.closest('.character') || e.target.closest('.controls') || 
                    e.target.closest('.music-controls') || e.target.closest('.chat-input') ||
                    e.target.closest('.music-toggle')) {
                    return;
                }
                
                const rect = roomContainer.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                
                moveCharacterTo(x, y);
                showMoveIndicator(e.clientX - rect.left, e.clientY - rect.top);
            });
        }

        function moveCharacterTo(x, y) {
            if (!gameState.myCharacter || gameState.isSitting) return;
            
            // Clamp positions to room boundaries
            x = Math.max(5, Math.min(95, x));
            y = Math.max(10, Math.min(90, y));
            
            gameState.moveTarget = { x, y };
            gameState.isMoving = true;
            gameState.myCharacter.classList.add('walking');
            
            // Animate movement
            gameState.myCharacter.style.transition = 'left 1s ease-out, top 1s ease-out';
            gameState.myCharacter.style.left = x + '%';
            gameState.myCharacter.style.top = y + '%';
            
            // Stop walking animation after movement
            setTimeout(() => {
                gameState.isMoving = false;
                gameState.myCharacter.classList.remove('walking');
                gameState.myCharacter.style.transition = '';
                gameState.moveTarget = null;
            }, 1000);
        }

        function showMoveIndicator(x, y) {
            const indicator = document.createElement('div');
            indicator.className = 'move-indicator';
            indicator.style.left = (x - 10) + 'px';
            indicator.style.top = (y - 10) + 'px';
            
            document.querySelector('.room-container').appendChild(indicator);
            
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.remove();
                }
            }, 1000);
        }

        function sitDown() {
            if (!gameState.isSitting) {
                gameState.isSitting = true;
                gameState.myCharacter.classList.remove('standing', 'walking');
                gameState.myCharacter.classList.add('sitting', 'meditating');
                updateButtonStates();
                
                // Increment meditation counter
                gameState.meditationDays++;
                saveUserData();
                
                playSound('sit');
            }
        }

        function standUp() {
            if (gameState.isSitting) {
                gameState.isSitting = false;
                gameState.myCharacter.classList.remove('sitting', 'meditating');
                gameState.myCharacter.classList.add('standing');
                updateButtonStates();
                
                playSound('stand');
            }
        }

        function updateButtonStates() {
            const standBtn = document.getElementById('standBtn');
            const sitBtn = document.getElementById('sitBtn');
            
            if (gameState.isSitting) {
                standBtn.classList.remove('active');
                sitBtn.classList.add('active');
            } else {
                standBtn.classList.add('active');
                sitBtn.classList.remove('active');
            }
        }

        function sendMessage() {
            const input = document.getElementById('chatMessage');
            const message = input.value.trim();
            
            if (message && message.length <= 160) {
                showChatBubble(gameState.myCharacter, message);
                input.value = '';
            }
        }

        function showChatBubble(character, message) {
            // Remove existing bubble
            const existingBubble = character.querySelector('.chat-bubble');
            if (existingBubble) {
                existingBubble.remove();
            }
            
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble';
            bubble.textContent = message;
            
            // Calculate width based on message length but respect character width
            const charWidth = character.offsetWidth;
            bubble.style.maxWidth = charWidth + 'px';
            bubble.style.minWidth = charWidth + 'px';
            
            character.appendChild(bubble);
            
            setTimeout(() => {
                if (bubble.parentNode) {
                    bubble.remove();
                }
            }, 5000);
        }

        function showProfile() {
            const modal = document.getElementById('profileModal');
            
            document.getElementById('userName').value = gameState.userName;
            
            // Update achievements
            const weeks = Math.floor(gameState.meditationDays / 7);
            const stars = Math.min(weeks, 10);
            document.getElementById('achievementStars').textContent = '‚≠ê'.repeat(stars) || 'üå±';
            
            let achievementText = 'Thi·ªÅn sinh m·ªõi b·∫Øt ƒë·∫ßu';
            if (weeks >= 1) achievementText = 'Ki√™n tr√¨ 1 tu·∫ßn';
            if (weeks >= 2) achievementText = 'Thi·ªÅn sinh t·∫≠n t√¢m';
            if (weeks >= 4) achievementText = 'Thi·ªÅn s∆∞ nh·ªè';
            if (weeks >= 8) achievementText = 'B·∫≠c th·∫ßy thi·ªÅn ƒë·ªãnh';
            if (weeks >= 16) achievementText = 'Enlightened Master';
            
            document.getElementById('achievementText').textContent = achievementText;
            
            // Update profile avatar head
            updateCharacterHead();
            
            modal.style.display = 'flex';
        }

        function closeProfile() {
            document.getElementById('profileModal').style.display = 'none';
        }

        function saveProfile() {
            gameState.userName = document.getElementById('userName').value || 'Thi·ªÅn sinh m·ªõi';
            
            // Update character status
            if (gameState.myCharacter) {
                const status = gameState.myCharacter.querySelector('.character-status');
                if (status) {
                    status.textContent = gameState.userName;
                }
            }
            
            saveUserData();
            closeProfile();
        }

        function showCharacterProfile(characterData) {
            const modal = document.getElementById('characterModal');
            
            document.getElementById('characterHead').textContent = characterData.emoji;
            document.getElementById('characterName').textContent = characterData.name;
            document.getElementById('characterStars').textContent = '‚≠ê'.repeat(characterData.stars);
            
            const bios = [
                'Thi·ªÅn sinh m·ªõi b·∫Øt ƒë·∫ßu h√†nh tr√¨nh t√¨m hi·ªÉu b·∫£n th√¢n.',
                'Ng∆∞·ªùi y√™u thi√™n nhi√™n v√† t√¨m ki·∫øm s·ª± b√¨nh an n·ªôi t√¢m.',
                'Thi·ªÅn s∆∞ tr·∫ª v·ªõi ni·ªÅm ƒëam m√™ chia s·∫ª tr√≠ tu·ªá.',
                'B·∫≠c th·∫ßy thi·ªÅn ƒë·ªãnh v·ªõi nhi·ªÅu nƒÉm kinh nghi·ªám.'
            ];
            
            document.getElementById('characterBio').textContent = bios[Math.min(characterData.stars - 1, 3)];
            modal.style.display = 'flex';
        }

        function closeCharacterModal() {
            document.getElementById('characterModal').style.display = 'none';
        }

        function setupBackgroundOptions() {
            const backgrounds = {
                garden: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                forest: 'linear-gradient(135deg, #4caf50 0%, #8bc34a 100%)',
                mountain: 'linear-gradient(135deg, #2196f3 0%, #21cbf3 100%)',
                sunset: 'linear-gradient(135deg, #ff9800 0%, #f44336 100%)',
                night: 'linear-gradient(135deg, #673ab7 0%, #3f51b5 100%)',
                zen: 'linear-gradient(135deg, #795548 0%, #8d6e63 100%)'
            };
            
            const options = document.querySelectorAll('.bg-option');
            options.forEach(option => {
                const bg = option.dataset.bg;
                option.style.backgroundImage = backgrounds[bg];
                option.onclick = () => {
                    options.forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    gameState.currentBackground = bg;
                };
            });
            
            // Custom background upload
            document.getElementById('customBackground').onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        gameState.currentBackground = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };
        }

        function showBackgroundSelector() {
            document.getElementById('backgroundSelector').style.display = 'block';
        }

        function closeBackgroundSelector() {
            document.getElementById('backgroundSelector').style.display = 'none';
        }

        function applyBackground() {
            const container = document.querySelector('.room-background');
            
            if (gameState.currentBackground.startsWith('data:')) {
                // Custom uploaded image
                container.style.backgroundImage = `url('${gameState.currentBackground}')`;
            } else {
                // Predefined backgrounds
                const backgrounds = {
                    garden: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    forest: 'linear-gradient(135deg, #4caf50 0%, #8bc34a 100%)',
                    mountain: 'linear-gradient(135deg, #2196f3 0%, #21cbf3 100%)',
                    sunset: 'linear-gradient(135deg, #ff9800 0%, #f44336 100%)',
                    night: 'linear-gradient(135deg, #673ab7 0%, #3f51b5 100%)',
                    zen: 'linear-gradient(135deg, #795548 0%, #8d6e63 100%)'
                };
                container.style.backgroundImage = backgrounds[gameState.currentBackground];
            }
            
            saveUserData();
            closeBackgroundSelector();
        }

        // Add sound effects for interactions
        function playSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                switch(type) {
                    case 'sit':
                        oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(220, audioContext.currentTime + 0.5);
                        break;
                    case 'stand':
                        oscillator.frequency.setValueAtTime(220, audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(440, audioContext.currentTime + 0.3);
                        break;
                    case 'move':
                        oscillator.frequency.setValueAtTime(330, audioContext.currentTime);
                        break;
                }
                
                gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch(e) {
                // Sound not supported, silently continue
            }
        }

        // Initialize on load
        window.onload = init;

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 's' || e.key === 'S') {
                if (gameState.isSitting) {
                    standUp();
                } else {
                    sitDown();
                }
            }
            if (e.key === 'Enter' && document.activeElement.id === 'chatMessage') {
                sendMessage();
            }
            if (e.key === 'm' || e.key === 'M') {
                toggleMusicPanel();
            }
        });

        // Add touch support for mobile
        let touchStartX, touchStartY;
        
        document.addEventListener('touchstart', function(e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });
        
        document.addEventListener('touchend', function(e) {
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            
            // Check if it's a tap (not a swipe)
            const deltaX = Math.abs(touchEndX - touchStartX);
            const deltaY = Math.abs(touchEndY - touchStartY);
            
            if (deltaX < 10 && deltaY < 10) {
                // Trigger click event for tap
                const clickEvent = new MouseEvent('click', {
                    clientX: touchEndX,
                    clientY: touchEndY,
                    bubbles: true
                });
                e.target.dispatchEvent(clickEvent);
            }
        });

        // Periodic character animations for demo characters
        setInterval(() => {
            gameState.characters.forEach((characterObj) => {
                const character = characterObj.element;
                
                // Random chance for demo characters to chat
                if (Math.random() > 0.95) {
                    const messages = [
                        'Om mani padme hum üïâÔ∏è', 
                        'B√¨nh an trong t√¢m üôè', 
                        'H·∫°nh ph√∫c th·∫≠t s·ª± ‚ú®',
                        'Thi·ªÅn ƒë·ªãnh m·ªói ng√†y üßò',
                        'C·∫£m ∆°n v≈© tr·ª• üåå',
                        'Y√™u th∆∞∆°ng v√¥ b·ªù ‚ù§Ô∏è'
                    ];
                    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                    showChatBubble(character, randomMessage);
                }
                
                // Random chance to change meditation state
                if (Math.random() > 0.98) {
                    if (character.classList.contains('sitting')) {
                        character.classList.remove('sitting', 'meditating');
                        character.classList.add('standing');
                    } else {
                        character.classList.remove('standing');
                        character.classList.add('sitting', 'meditating');
                    }
                }
            });
        }, 2000);

        // Auto-save meditation progress
        setInterval(() => {
            if (gameState.isSitting) {
                gameState.meditationDays += 0.01;
                
                // Show meditation benefits occasionally
                if (Math.random() > 0.97) {
                    const benefits = [
                        'T√¢m tr√≠ ƒëang th∆∞ gi√£n... üòå',
                        'CƒÉng th·∫≥ng ƒëang tan bi·∫øn... üå∏',
                        'NƒÉng l∆∞·ª£ng t√≠ch c·ª±c tƒÉng... ‚ú®',
                        'S·ª± t·∫≠p trung ƒë∆∞·ª£c c·∫£i thi·ªán... üéØ',
                        'B√¨nh an n·ªôi t√¢m lan t·ªèa... üïäÔ∏è'
                    ];
                    showChatBubble(gameState.myCharacter, benefits[Math.floor(Math.random() * benefits.length)]);
                }
            }
        }, 10000);

        // Weather effects
        function createWeatherEffect() {
            if (Math.random() > 0.9) {
                const effects = ['üå∏', '‚ùÑÔ∏è', 'üíß'];
                const effect = effects[Math.floor(Math.random() * effects.length)];
                
                for (let i = 0; i < 10; i++) {
                    setTimeout(() => {
                        createWeatherParticle(effect);
                    }, i * 200);
                }
            }
        }

        function createWeatherParticle(emoji) {
            const particle = document.createElement('div');
            particle.style.position = 'absolute';
            particle.style.pointerEvents = 'none';
            particle.style.zIndex = '2';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.top = '-10px';
            particle.textContent = emoji;
            particle.style.fontSize = (Math.random() * 8 + 8) + 'px';
            particle.style.animation = `fall ${Math.random() * 3 + 2}s linear forwards`;
            
            document.querySelector('.room-container').appendChild(particle);
            
            setTimeout(() => {
                if (particle.parentNode) {
                    particle.remove();
                }
            }, 5000);
        }

        // Start weather effects
        setInterval(createWeatherEffect, 30000);

        // Performance optimization
        document.addEventListener('visibilitychange', function() {
            const characters = document.querySelectorAll('.character');
            characters.forEach(char => {
                if (document.hidden) {
                    char.style.animationPlayState = 'paused';
                } else {
                    char.style.animationPlayState = 'running';
                }
            });
        });

        // Easter egg - Konami code
        let konamiCode = [];
        const konamiSequence = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'KeyB', 'KeyA'];
        
        document.addEventListener('keydown', function(e) {
            konamiCode.push(e.code);
            if (konamiCode.length > konamiSequence.length) {
                konamiCode.shift();
            }
            
            if (JSON.stringify(konamiCode) === JSON.stringify(konamiSequence)) {
                showChatBubble(gameState.myCharacter, 'üåü ENLIGHTENMENT ACHIEVED! üåü');
                gameState.myCharacter.style.filter = 'drop-shadow(0 0 30px gold) hue-rotate(45deg)';
                setTimeout(() => {
                    gameState.myCharacter.style.filter = '';
                }, 5000);
                konamiCode = [];
            }
        });
    </script>
</body>
</html>
